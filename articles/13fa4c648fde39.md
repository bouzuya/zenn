---
emoji: "😎"
publication_name: "doctormate"
published: true
published_at: 2026-02-09 12:00
title: "axum crate の IntoResponse の標準で提供される実装 (1)"
topics: ["rust"]
type: "tech"
---

# axum crate の IntoResponse の標準で提供される実装 (1)

[前回は axum crate の FromRequest の標準で提供される実装を見ました](https://zenn.dev/doctormate/articles/5949668be45972)。

今回は axum crate の `IntoResponse` trait を見ます。

今回も axum crate のバージョンは 0.8.4 です。

## axum crate の Response

axum では `IntoResponse` trait を実装しているものを Handler の戻り値 Response として使えます。

[Handler の実装を見た回](https://zenn.dev/doctormate/articles/7f7114a3b12e87) で見た実装でも、確かにトレイト境界に `Res: IntoResponse` が設定されています。

これまでのように `IntoResponse` の実装を見てもいいのですが、件数が多いです。 `IntoResponse` の実装は内部で他の実装に任せるものが多いので、そうやって集約された先になりそうな一部を取り上げて見ていきます。

## impl&lt;B&gt; IntoResponse for Response&lt;B&gt;

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Response%3CB%3E>

```rust
impl<B> IntoResponse for Response<B>
where
    B: http_body::Body<Data = Bytes> + Send + 'static,
    B::Error: Into<BoxError>,
{
    fn into_response(self) -> Response {
        self.map(Body::new)
    }
}
```

まずは `Response<B>` で `Body` の型の変換だけのもの。 `IntoResponse` というか、そも既にほとんど `Response` です。 `http::Response::map` で Body の型を変換します。

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.map>

`Body::new` していることから分かるとおり、 `B` は `axum::body::Body::new` のトレイト境界と一致しています。

<https://docs.rs/axum/0.8.4/axum/body/struct.Body.html#method.new>

## impl IntoResponse for Body

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Body>

```rust
impl IntoResponse for Body {
    fn into_response(self) -> Response {
        Response::new(self)
    }
}
```

Body っぽいものは Body (`axum::body::Body`) に処理を転送されがちです。

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.new>

`Response::new` して `http::Response<axum::body::Body>` の基本の形に持っていくだけです。

Body っぽいものの例としては↓のようなものです。バイト列や文字列などですね。

- `()` (`Body::empty()` に)
- `String` (`Cow<'static, str>` 経由で `Body::from` で `Body` に)
- `Bytes` (`Body::from` で `Body` に)
- `Vec<u8>` (`Cow<'static, [u8]>` 経由で `Body::from` で `Body` に)

これらは `Body` に丸投げや `IntoResponse` で Response にしたあと Content-Type を変更する程度になっています。

## impl IntoResponse for Parts

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Parts>

```rust
impl IntoResponse for http::response::Parts {
    fn into_response(self) -> Response {
        Response::from_parts(self, Body::empty())
    }
}
```

`Response::from_parts` して、 body は `Body::empty()` にしていますね。

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.from_parts>

一例として Parts を出しましたが、意外と Parts っぽいものは Parts (`http::response::Parts`) に処理を転送されていません。 `().into_response()` で Response にしたあと、それぞれの箇所を変更していることが多そうです。

Parts っぽいものの例としては↓のようなものです。

- `StatusCode`
- `HeaderMap`
- `Extensions`

## impl&lt;R&gt; IntoResponse for (Parts, R)

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-(Parts,+R)>

```rust
impl<R> IntoResponse for (http::response::Parts, R)
where
    R: IntoResponse,
{
    fn into_response(self) -> Response {
        let (parts, res) = self;
        (parts.status, parts.headers, parts.extensions, res).into_response()
    }
}
```

転送先ではないのですが、 Parts っぽいものと IntoResponse の組は代表的な形のように思います。実用上、多そうなのは `(StatusCode, impl IntoResponse)` などですね。

これらの実装 (転送先) はマクロによるものになります。いくつかの形の tuple をまとめて定義しているのですが、ひとつだけ挙げます。

```rust
macro_rules! impl_into_response {
    ( $($ty:ident),* $(,)? ) => {
        #[allow(non_snake_case)]
        impl<R, $($ty,)*> IntoResponse for ($($ty),*, R)
        where
            $( $ty: IntoResponseParts, )*
            R: IntoResponse,
        {
            fn into_response(self) -> Response {
                let ($($ty),*, res) = self;

                let res = res.into_response();
                let parts = ResponseParts { res };

                $(
                    let parts = match $ty.into_response_parts(parts) {
                        Ok(parts) => parts,
                        Err(err) => {
                            return err.into_response();
                        }
                    };
                )*

                parts.res
            }
        }

        // ...
    }
}
```

```rust
all_the_tuples_no_last_special_case!(impl_into_response);
```

全体的な構成は Extractor のときの `FromRequest` と `FromRequestParts` の組み合わせに似た形です。

`all_the_tuples_no_last_special_case` はおおむね引数に与えられたマクロを T1, .., T16 の可変の引数に対して呼び出すものです。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/macros.rs#L252-L271>

body を `IntoResponse` で組み立てた上で、 `IntoResponseParts` trait を実装しているものに対して、順に `into_response_parts` して失敗すれば途中で抜け、 `parts` を順に処理して、最後に `parts.res` を返しています。

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponseParts.html>
<https://docs.rs/axum/0.8.4/axum/response/struct.ResponseParts.html>

`ResponseParts` struct は Response の parts 部分だけを `IntoResponseParts` で設定可能な形で公開するためのものですね。

細かい点ですが、 body よりも後に parts 側が処理されて header などを上書きできるようにしているのもポイントなのかもしれません。例えば `String` だと通常 Content-Type が plain/text 扱いされてしまうのですが、 `(String, HeaderMap)` のような tuple で指定したときに text/html にできます。逆にしてしまうと困りそうです。

## おわりに

今回は axum crate の IntoResponse の標準で提供される実装の一部を見ました。

まだ `Result<impl IntoResponse, impl IntoResponse>` やエラーっぽいものを見ていないのですが、文量的に次回にしようと思います。
