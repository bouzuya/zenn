---
emoji: "ğŸ˜"
publication_name: "doctormate"
published: true
published_at: 2026-02-09 12:00
title: "axum crate ã® IntoResponse ã®æ¨™æº–ã§æä¾›ã•ã‚Œã‚‹å®Ÿè£… (1)"
topics: ["rust"]
type: "tech"
---

# axum crate ã® IntoResponse ã®æ¨™æº–ã§æä¾›ã•ã‚Œã‚‹å®Ÿè£… (1)

[å‰å›ã¯ axum crate ã® FromRequest ã®æ¨™æº–ã§æä¾›ã•ã‚Œã‚‹å®Ÿè£…ã‚’è¦‹ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/5949668be45972)ã€‚

ä»Šå›ã¯ axum crate ã® `IntoResponse` trait ã‚’è¦‹ã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.4 ã§ã™ã€‚

## axum crate ã® Response

axum ã§ã¯ `IntoResponse` trait ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚‚ã®ã‚’ Handler ã®æˆ»ã‚Šå€¤ Response ã¨ã—ã¦ä½¿ãˆã¾ã™ã€‚

[Handler ã®å®Ÿè£…ã‚’è¦‹ãŸå›](https://zenn.dev/doctormate/articles/7f7114a3b12e87) ã§è¦‹ãŸå®Ÿè£…ã§ã‚‚ã€ç¢ºã‹ã«ãƒˆãƒ¬ã‚¤ãƒˆå¢ƒç•Œã« `Res: IntoResponse` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã¾ã§ã®ã‚ˆã†ã« `IntoResponse` ã®å®Ÿè£…ã‚’è¦‹ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€ä»¶æ•°ãŒå¤šã„ã§ã™ã€‚ `IntoResponse` ã®å®Ÿè£…ã¯å†…éƒ¨ã§ä»–ã®å®Ÿè£…ã«ä»»ã›ã‚‹ã‚‚ã®ãŒå¤šã„ã®ã§ã€ãã†ã‚„ã£ã¦é›†ç´„ã•ã‚ŒãŸå…ˆã«ãªã‚Šãã†ãªä¸€éƒ¨ã‚’å–ã‚Šä¸Šã’ã¦è¦‹ã¦ã„ãã¾ã™ã€‚

## impl&lt;B&gt; IntoResponse for Response&lt;B&gt;

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Response%3CB%3E>

```rust
impl<B> IntoResponse for Response<B>
where
    B: http_body::Body<Data = Bytes> + Send + 'static,
    B::Error: Into<BoxError>,
{
    fn into_response(self) -> Response {
        self.map(Body::new)
    }
}
```

ã¾ãšã¯ `Response<B>` ã§ `Body` ã®å‹ã®å¤‰æ›ã ã‘ã®ã‚‚ã®ã€‚ `IntoResponse` ã¨ã„ã†ã‹ã€ãã‚‚æ—¢ã«ã»ã¨ã‚“ã© `Response` ã§ã™ã€‚ `http::Response::map` ã§ Body ã®å‹ã‚’å¤‰æ›ã—ã¾ã™ã€‚

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.map>

`Body::new` ã—ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰åˆ†ã‹ã‚‹ã¨ãŠã‚Šã€ `B` ã¯ `axum::body::Body::new` ã®ãƒˆãƒ¬ã‚¤ãƒˆå¢ƒç•Œã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/body/struct.Body.html#method.new>

## impl IntoResponse for Body

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Body>

```rust
impl IntoResponse for Body {
    fn into_response(self) -> Response {
        Response::new(self)
    }
}
```

Body ã£ã½ã„ã‚‚ã®ã¯ Body (`axum::body::Body`) ã«å‡¦ç†ã‚’è»¢é€ã•ã‚ŒãŒã¡ã§ã™ã€‚

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.new>

`Response::new` ã—ã¦ `http::Response<axum::body::Body>` ã®åŸºæœ¬ã®å½¢ã«æŒã£ã¦ã„ãã ã‘ã§ã™ã€‚

Body ã£ã½ã„ã‚‚ã®ã®ä¾‹ã¨ã—ã¦ã¯â†“ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚ãƒã‚¤ãƒˆåˆ—ã‚„æ–‡å­—åˆ—ãªã©ã§ã™ã­ã€‚

- `()` (`Body::empty()` ã«)
- `String` (`Cow<'static, str>` çµŒç”±ã§ `Body::from` ã§ `Body` ã«)
- `Bytes` (`Body::from` ã§ `Body` ã«)
- `Vec<u8>` (`Cow<'static, [u8]>` çµŒç”±ã§ `Body::from` ã§ `Body` ã«)

ã“ã‚Œã‚‰ã¯ `Body` ã«ä¸¸æŠ•ã’ã‚„ `IntoResponse` ã§ Response ã«ã—ãŸã‚ã¨ Content-Type ã‚’å¤‰æ›´ã™ã‚‹ç¨‹åº¦ã«ãªã£ã¦ã„ã¾ã™ã€‚

## impl IntoResponse for Parts

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-Parts>

```rust
impl IntoResponse for http::response::Parts {
    fn into_response(self) -> Response {
        Response::from_parts(self, Body::empty())
    }
}
```

`Response::from_parts` ã—ã¦ã€ body ã¯ `Body::empty()` ã«ã—ã¦ã„ã¾ã™ã­ã€‚

<https://docs.rs/http/1.3.1/http/response/struct.Response.html#method.from_parts>

ä¸€ä¾‹ã¨ã—ã¦ Parts ã‚’å‡ºã—ã¾ã—ãŸãŒã€æ„å¤–ã¨ Parts ã£ã½ã„ã‚‚ã®ã¯ Parts (`http::response::Parts`) ã«å‡¦ç†ã‚’è»¢é€ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ `().into_response()` ã§ Response ã«ã—ãŸã‚ã¨ã€ãã‚Œãã‚Œã®ç®‡æ‰€ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šãã†ã§ã™ã€‚

Parts ã£ã½ã„ã‚‚ã®ã®ä¾‹ã¨ã—ã¦ã¯â†“ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

- `StatusCode`
- `HeaderMap`
- `Extensions`

## impl&lt;R&gt; IntoResponse for (Parts, R)

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponse.html#impl-IntoResponse-for-(Parts,+R)>

```rust
impl<R> IntoResponse for (http::response::Parts, R)
where
    R: IntoResponse,
{
    fn into_response(self) -> Response {
        let (parts, res) = self;
        (parts.status, parts.headers, parts.extensions, res).into_response()
    }
}
```

è»¢é€å…ˆã§ã¯ãªã„ã®ã§ã™ãŒã€ Parts ã£ã½ã„ã‚‚ã®ã¨ IntoResponse ã®çµ„ã¯ä»£è¡¨çš„ãªå½¢ã®ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚å®Ÿç”¨ä¸Šã€å¤šãã†ãªã®ã¯ `(StatusCode, impl IntoResponse)` ãªã©ã§ã™ã­ã€‚

ã“ã‚Œã‚‰ã®å®Ÿè£… (è»¢é€å…ˆ) ã¯ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®å½¢ã® tuple ã‚’ã¾ã¨ã‚ã¦å®šç¾©ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã²ã¨ã¤ã ã‘æŒ™ã’ã¾ã™ã€‚

```rust
macro_rules! impl_into_response {
    ( $($ty:ident),* $(,)? ) => {
        #[allow(non_snake_case)]
        impl<R, $($ty,)*> IntoResponse for ($($ty),*, R)
        where
            $( $ty: IntoResponseParts, )*
            R: IntoResponse,
        {
            fn into_response(self) -> Response {
                let ($($ty),*, res) = self;

                let res = res.into_response();
                let parts = ResponseParts { res };

                $(
                    let parts = match $ty.into_response_parts(parts) {
                        Ok(parts) => parts,
                        Err(err) => {
                            return err.into_response();
                        }
                    };
                )*

                parts.res
            }
        }

        // ...
    }
}
```

```rust
all_the_tuples_no_last_special_case!(impl_into_response);
```

å…¨ä½“çš„ãªæ§‹æˆã¯ Extractor ã®ã¨ãã® `FromRequest` ã¨ `FromRequestParts` ã®çµ„ã¿åˆã‚ã›ã«ä¼¼ãŸå½¢ã§ã™ã€‚

`all_the_tuples_no_last_special_case` ã¯ãŠãŠã‚€ã­å¼•æ•°ã«ä¸ãˆã‚‰ã‚ŒãŸãƒã‚¯ãƒ­ã‚’ T1, .., T16 ã®å¯å¤‰ã®å¼•æ•°ã«å¯¾ã—ã¦å‘¼ã³å‡ºã™ã‚‚ã®ã§ã™ã€‚

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/macros.rs#L252-L271>

body ã‚’ `IntoResponse` ã§çµ„ã¿ç«‹ã¦ãŸä¸Šã§ã€ `IntoResponseParts` trait ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚‚ã®ã«å¯¾ã—ã¦ã€é †ã« `into_response_parts` ã—ã¦å¤±æ•—ã™ã‚Œã°é€”ä¸­ã§æŠœã‘ã€ `parts` ã‚’é †ã«å‡¦ç†ã—ã¦ã€æœ€å¾Œã« `parts.res` ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/response/trait.IntoResponseParts.html>
<https://docs.rs/axum/0.8.4/axum/response/struct.ResponseParts.html>

`ResponseParts` struct ã¯ Response ã® parts éƒ¨åˆ†ã ã‘ã‚’ `IntoResponseParts` ã§è¨­å®šå¯èƒ½ãªå½¢ã§å…¬é–‹ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã­ã€‚

ç´°ã‹ã„ç‚¹ã§ã™ãŒã€ body ã‚ˆã‚Šã‚‚å¾Œã« parts å´ãŒå‡¦ç†ã•ã‚Œã¦ header ãªã©ã‚’ä¸Šæ›¸ãã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã‚‚ãƒã‚¤ãƒ³ãƒˆãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä¾‹ãˆã° `String` ã ã¨é€šå¸¸ Content-Type ãŒ plain/text æ‰±ã„ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã™ãŒã€ `(String, HeaderMap)` ã®ã‚ˆã†ãª tuple ã§æŒ‡å®šã—ãŸã¨ãã« text/html ã«ã§ãã¾ã™ã€‚é€†ã«ã—ã¦ã—ã¾ã†ã¨å›°ã‚Šãã†ã§ã™ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ axum crate ã® IntoResponse ã®æ¨™æº–ã§æä¾›ã•ã‚Œã‚‹å®Ÿè£…ã®ä¸€éƒ¨ã‚’è¦‹ã¾ã—ãŸã€‚

ã¾ã  `Result<impl IntoResponse, impl IntoResponse>` ã‚„ã‚¨ãƒ©ãƒ¼ã£ã½ã„ã‚‚ã®ã‚’è¦‹ã¦ã„ãªã„ã®ã§ã™ãŒã€æ–‡é‡çš„ã«æ¬¡å›ã«ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
