---
emoji: "ğŸ™"
publication_name: "doctormate"
published: false
# published_at: 2026-03-16 12:00
title: "axum crate ã® Middleware (3) axum::middleware::from_extractor"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Writing middleware ã‹ã‚‰ axum::middleware::from_fn ã«ã¤ã„ã¦è¦‹ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/667a79400b5815)ã€‚

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ `axum::middleware::from_extractor` ä»¥é™ã‚’èª­ã‚“ã§ã„ãã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.6 ã§ã™ã€‚

## axum::middleware::from_extractor ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã¾ãšã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¾ã™ã€‚å‰å›ã¯ `axum::middleware::from_fn` ã®ã¨ã“ã‚ã¾ã§ã ã£ãŸã®ã§ã€ãã®ç¶šãã‹ã‚‰ã§ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/index.html>

[`axum::middleware::from_extractor`](https://docs.rs/axum/0.8.6/axum/middleware/fn.from_extractor.html)

ã“ã‚Œã¯ Extractor ã‹ã‚‰ Middleware ã‚’ä½œæˆã™ã‚‹ã‚‚ã®ã§ã™ã€‚æˆåŠŸã™ã‚Œã°æŠ½å‡ºã•ã‚ŒãŸå€¤ã¯æ¨ã¦ã‚‰ã‚Œã¦å¾Œç¶šã® Service ãŒå‘¼ã³å‡ºã•ã‚Œã€å¤±æ•—ã™ã‚Œã°å¾Œç¶šã® Service ã¯å‘¼ã³å‡ºã•ã‚Œãªã„ã€‚ã¾ãŸ `FromRequest` (Request Bodyã‚’æ¶ˆè²»ã™ã‚‹ã‚‚ã®) ã®å ´åˆã€å¾Œç¶šã® Service ã§ã¯ Request Body ãŒèª­ã‚ãªã„â€¦â€¦ã¨ã®ã“ã¨ã§ã™ã€‚

ã¤ã¾ã‚Šã€ Extractor ã ã‘ã©å®Ÿéš›ã«å€¤ã‚’æŠ½å‡ºã—ã¦ä½¿ã†ã®ã§ã¯ãªãå€¤ã‚’æŠ½å‡ºã§ãã‚‹ã‹ã®åˆ¤å®šã‚’ä½¿ã†ã¨ã„ã†ã“ã¨ã¿ãŸã„ã§ã™ã­ã€‚

ä¾‹ã«ã‚‚ã‚ã‚‹ã¨ãŠã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰èªè¨¼ç”¨ã®æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ã¿ãŸã„ãª Extractor ã‚’ã€å„ Handler ã«éƒ½åº¦å…¥ã‚Œã‚‹ã¨å†—é•·ã«ãªã‚‹ã‹ã‚‰ Middleware ã¨ã—ã¦ä¸€æ‹¬è¨­å®šã—ã¦ã‚ã’ã‚Œã°â€¦â€¦ã¨ã„ã†ã®ãŒãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦åˆ†ã‹ã‚Šã‚„ã™ãã†ã§ã™ã­ã€‚

## axum::middleware::from_extractor ã®å®Ÿè£…

`axum::middleware::from_extractor` ã®å®Ÿè£…ã¯â€¦â€¦

```rust
pub fn from_extractor<E>() -> FromExtractorLayer<E, ()> {
    from_extractor_with_state(())
}
```

`from_extractor_with_state` ã«ä¸¸æŠ•ã’ã§ã™ã­ã€‚ã“ã‚Œã¯å‰å›ã® `axum::middleware::from_fn` ã¨ã»ã¨ã‚“ã©åŒã˜å½¢ã§ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/fn.from_extractor_with_state.html>

```rust
pub fn from_extractor_with_state<E, S>(state: S) -> FromExtractorLayer<E, S> {
    FromExtractorLayer {
        state,
        _marker: PhantomData,
    }
}
```

`FromExtractorLayer` ã‚’è¿”ã—ã¾ã™ã€‚æ—¢è¦–æ„ŸãŒã‚ã‚Šã¾ã™ã€‚

```rust
impl<E, T, S> Layer<T> for FromExtractorLayer<E, S>
where
    S: Clone,
{
    type Service = FromExtractor<T, E, S>;

    fn layer(&self, inner: T) -> Self::Service {
        FromExtractor {
            inner,
            state: self.state.clone(),
            _extractor: PhantomData,
        }
    }
}
```

`FromExtractor` ã‚’è¿”ã—ã¾ã™ã€‚æ—¢è¦–æ„ŸãŒã‚ã‚Šã¾ã™ã€‚

```rust
impl<T, E, B, S> Service<Request<B>> for FromExtractor<T, E, S>
where
    E: FromRequestParts<S> + 'static,
    B: Send + 'static,
    T: Service<Request<B>> + Clone,
    T::Response: IntoResponse,
    S: Clone + Send + Sync + 'static,
{
    type Response = Response;
    type Error = T::Error;
    type Future = ResponseFuture<B, T, E, S>;

    #[inline]
    fn poll_ready(&mut self, cx: &mut Context<'_>) -> Poll<Result<(), Self::Error>> {
        self.inner.poll_ready(cx)
    }

    fn call(&mut self, req: Request<B>) -> Self::Future {
        let state = self.state.clone();
        let (mut parts, body) = req.into_parts();

        let extract_future = Box::pin(async move {
            let extracted = E::from_request_parts(&mut parts, &state).await;
            let req = Request::from_parts(parts, body);
            (req, extracted)
        });

        ResponseFuture {
            state: State::Extracting {
                future: extract_future,
            },
            svc: Some(self.inner.clone()),
        }
    }
}
```

Extractor è‡ªä½“ãŒ `FromRequestParts` ã‚„ `FromRequest` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§ã€å‰å›ã® `from_fn` ã¨ã¯ç•°ãªã‚Š `impl Service for FromExtractor` ã¯ãƒã‚¯ãƒ­ã§å¯å¤‰ã«å¯¾å¿œã™ã‚‹å½¢ã§ã¯å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

`from_request_parts` ã‚’å‘¼ã³å‡ºã™ã ã‘ã§ã¯ã‚ã‚Šã¾ã™ã­ã€‚

`ResponseFuture` ã¯ `impl Future for ResponseFuture` ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚èª¬æ˜é€šã‚Š Extractor ãŒæˆåŠŸã™ã‚Œã° inner service ã‚’å‘¼ã³å‡ºã—ã€å¤±æ•—ã™ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’ into_response ã—ã¦è¿”ã™ã‚‚ã®ã§ã™ã€‚

```rust
pin_project! {
    /// Response future for [`FromExtractor`].
    #[allow(missing_debug_implementations)]
    pub struct ResponseFuture<B, T, E, S>
    where
        E: FromRequestParts<S>,
        T: Service<Request<B>>,
    {
        #[pin]
        state: State<B, T, E, S>,
        svc: Option<T>,
    }
}

pin_project! {
    #[project = StateProj]
    enum State<B, T, E, S>
    where
        E: FromRequestParts<S>,
        T: Service<Request<B>>,
    {
        Extracting {
            future: BoxFuture<'static, (Request<B>, Result<E, E::Rejection>)>,
        },
        Call { #[pin] future: T::Future },
    }
}

impl<B, T, E, S> Future for ResponseFuture<B, T, E, S>
where
    E: FromRequestParts<S>,
    T: Service<Request<B>>,
    T::Response: IntoResponse,
{
    type Output = Result<Response, T::Error>;

    fn poll(mut self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output> {
        loop {
            let mut this = self.as_mut().project();

            let new_state = match this.state.as_mut().project() {
                StateProj::Extracting { future } => {
                    let (req, extracted) = ready!(future.as_mut().poll(cx));

                    match extracted {
                        Ok(_) => {
                            let mut svc = this.svc.take().expect("future polled after completion");
                            let future = svc.call(req);
                            State::Call { future }
                        }
                        Err(err) => {
                            let res = err.into_response();
                            return Poll::Ready(Ok(res));
                        }
                    }
                }
                StateProj::Call { future } => {
                    return future
                        .poll(cx)
                        .map(|result| result.map(IntoResponse::into_response));
                }
            };

            this.state.set(new_state);
        }
    }
}
```

`pin-project-lite` crate ã® `pin_project` ãƒã‚¯ãƒ­ã«ã¤ã„ã¦ã¯åˆ¥ã®æ©Ÿä¼šã«æ›¸ãã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ axum ã® middleware ã® `axum::middleware::from_extractor` ã‚’è¦‹ã¾ã—ãŸã€‚

ã™ã“ã—ãšã¤ã—ã‹é€²ã‚ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“â€¦â€¦ã€‚

æ¬¡å›ã‚‚å¼•ãç¶šãã€ä»–ã® Middleware ã‚’æ›¸ãæ–¹æ³•ã‚‚è¦‹ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
