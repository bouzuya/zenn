---
emoji: "🙌"
publication_name: "doctormate"
published: true
published_at: 2026-04-06 12:00
title: "axum crate の Middleware (6) Error handling など"
topics: ["rust"]
type: "tech"
---

[前回は axum の middleware のドキュメントの Writing middleware から tower::Service and Pin<Box<dyn Future>> について見ました](https://zenn.dev/doctormate/articles/698f2f63079de2)。

今回は axum の middleware の `tower::Service` and `Pin<Box<dyn Future>>` 以降のドキュメントを読みます。

<https://docs.rs/axum/0.8.6/axum/middleware/index.html>

今回も axum crate のバージョンは 0.8.6 です。

## `tower::Service` and custom futures

<https://github.com/tower-rs/tower/blob/master/guides/building-a-middleware-from-scratch.md> を読むと良いそうですが、 tower だけの内容になりそうなのでいきなりですが skip します。

## Error handling for middleware

これは[過去に見た `HandlerErrorLayer`](https://zenn.dev/doctormate/articles/0ae1263c351356) です。

axum で使用する場合は最終的にレスポンスを返さないといけないため、 `Result::Err` ではなく `Result::Ok` を返すようにする必要があり、そこを変換するための仕組みですね。

## Routing to services/middleware and backpressure

axum におけるバックプレッシャーの方針について書いてあります。

一般にルーティングとバックプレッシャーはうまく組み合わせられず、その理由は、リクエストの前にサービスの ready を確認したいが、どのサービスへルーティングされるかはリクエストを受けないと分からないことによります。

大きな方向性として↓がありますが、 axum は後者をとっているようです。

- すべてのサービスが ready になるまで、ルーターを ready にしない
- すべてのサービスを ready とみなして、ルーターを常に ready にする (axum はこちら)

axum ではバックプレッシャーを考慮するサービスはルーターに配置せず、ルーターの外側に配置すると良いようです。

## Accessing state in middleware

Middleware で State にアクセスする方法について書かれています。

### `axum::middleware::from_fn_with_state`

これは[過去に見た関数](https://zenn.dev/doctormate/articles/667a79400b5815)です。 `from_fn` の関数が State を取れるようになっているものです。 

実装としては `Layer` を実装した構造体に `State` と引数で渡した fn を持っておくものです。

`State` が `Clone` を実装していることが重要ですね。

### Accessing state in custom tower::Layers

独自の `tower::Layer` 実装から `State` にアクセスする場合のコード例があります。

……とは言え、内容としては fn 部分がないだけで `from_fn_with_state` の実装とほとんど同じです。

### Passing state from middleware to handlers

Middleware から Handler に State を渡す例があります。

Middleware では request の Extension に設定し、 Handler では Extension から Extractor で取り出す。なるほど。

### Rewriting request URI in middleware

最後はリクエストの URI を書き換える例です。

Router に Middleware を設定するとルーティング後になるため URI の書き換えはできません。そこで逆に Middleware として Router を使用します。 Router は `tower::Service` を実装しているので、これができます。こうすれば書き換えることができます。

これはバックプレッシャーのときの外側に配置とほとんど同じですね。

## おわりに

今回は axum の middleware のドキュメントを最後まで見ました。
