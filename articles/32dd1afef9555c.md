---
emoji: "ğŸ¡"
publication_name: "doctormate"
published: true
published_at: 2026-04-20 12:00
title: "#[must_use] ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†"
topics: ["rust"]
type: "tech"
---

## å°å…¥: Rust ã® must_use å±æ€§ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ

Rust ã® `#[must_use]` (must_use å±æ€§) ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ

Rust ã‚’è¶£å‘³ã‚„æ¥­å‹™ã§ã‚ã‚‹ç¨‹åº¦ã¯æ›¸ã„ã¦ã„ã¦ã‚‚ã€ã‚‚ã—ã‹ã™ã‚‹ã¨çŸ¥ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãŸã ã€ã“ã‚Œè‡ªä½“ã¯çŸ¥ã‚‰ãªãã¦ã‚‚ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ãŸåŠ¹æœã«ã¤ã„ã¦ã¯çŸ¥ã£ã¦ã„ã‚‹ (è¦‹ãŸã“ã¨ãŒã‚ã‚‹) ã¯ãšã§ã™ã€‚

## å®Ÿä¾‹: Result

ãŸã¨ãˆã°ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã“ã®å±æ€§ã®åŠ¹æœã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
fn main() {
    fn command() -> Result<(), Box<dyn std::error::Error>> {
        Ok(())
    }
    
    command();
}
```

`Result` ã‚’è¿”ã™é–¢æ•°ã§ã‚ã‚‹ `command` ãŒã‚ã‚Šã€å‘¼ã³å‡ºã—ã¾ã™ãŒã€ãã®æˆ»ã‚Šå€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã€ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ `Result` ã«ã¤ã„ã¦ã®ã€æ¬¡ã®ã‚ˆã†ãªè­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```text
warning: unused `Result` that must be used
 --> src/main.rs:6:5
  |
6 |     command();
  |     ^^^^^^^^^
  |
  = note: this `Result` may be an `Err` variant, which should be handled
  = note: `#[warn(unused_must_use)]` (part of `#[warn(unused)]`) on by default
help: use `let _ = ...` to ignore the resulting value
  |
6 |     let _ = command();
  |     +++++++
```

ã“ã“ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ `unused_must_use` ã®ãã£ã‹ã‘ã‚’ä¸ãˆã‚‹ã‚‚ã®ãŒ `#[must_use]` ã§ã™ã€‚

`Result` ã®å®šç¾©ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚

<https://github.com/rust-lang/rust/blob/1.91.1/library/core/src/result.rs#L541-L560>

```rust
/// `Result` is a type that represents either success ([`Ok`]) or failure ([`Err`]).
///
/// See the [module documentation](self) for details.
#[doc(search_unbox)]
#[derive(Copy, Debug, Hash)]
#[derive_const(PartialEq, PartialOrd, Eq, Ord)]
#[must_use = "this `Result` may be an `Err` variant, which should be handled"]
#[rustc_diagnostic_item = "Result"]
#[stable(feature = "rust1", since = "1.0.0")]
pub enum Result<T, E> {
    /// Contains the success value
    #[lang = "Ok"]
    #[stable(feature = "rust1", since = "1.0.0")]
    Ok(#[stable(feature = "rust1", since = "1.0.0")] T),

    /// Contains the error value
    #[lang = "Err"]
    #[stable(feature = "rust1", since = "1.0.0")]
    Err(#[stable(feature = "rust1", since = "1.0.0")] E),
}
```

ç¢ºã‹ã« must_use å±æ€§ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

## ä»–ã®ä¾‹: builder

ä»–ã®ä¾‹ã‚‚è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä½¿ç”¨ã›ãšã«æ¨ã¦ã¦ã—ã¾ã†ã®ãŒã¾ãšã„ã‚±ãƒ¼ã‚¹ã¯ `Result` ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ãŒã€ä»–ã«ã©ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

ã¼ããŒãƒ‘ãƒƒã¨æ€ã„ã¤ã„ãŸã®ã¯ builder ã£ã½ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã—ãŸã€‚

```rust
fn main() {
    #[derive(Clone, Default)]
    struct Options {
        b: bool,
        n: i32,
    }
    
    impl Options {
        #[must_use]
        fn b(&self, b: bool) -> Self {
            Self { b, ..self.clone() }
        }
        
        #[must_use]
        fn n(&self, n: i32) -> Self {
            Self { n, ..self.clone() }
        }
    }

    // èª¤ã£ãŸä½¿ã„æ–¹
    let options = Options::default();
    options.b(true); // å†…éƒ¨çŠ¶æ…‹ã‚’æ›¸ãæ›ãˆã‚‹ã‚‚ã®ã¨å‹˜é•ã„ 1
    options.n(123); // å‹˜é•ã„ 2
    println!("b={},n={}", options.b, options.n); // b=false,n=0

    // æœ¬æ¥æœŸå¾…ã—ã¦ã„ã‚‹ä½¿ã„æ–¹
    let options = Options::default().b(true).n(123);
    println!("b={},n={}", options.b, options.n); // b=true,n=123
}
```

ã“ã†ã„ã†ã‚±ãƒ¼ã‚¹ã§ã¯ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã« `#[must_use]` ã‚’æŒ‡å®šã—ã¦ã„ã‚Œã°ã€æ¬¡ã®ã‚ˆã†ãªè­¦å‘ŠãŒå‡ºã¦ã€æ°—ã¥ãã‚„ã™ããªã‚Šã¾ã™ã€‚

```text
warning: unused return value of `Options::b` that must be used
  --> src/main.rs:22:5
   |
22 |     options.b(true); // å†…éƒ¨çŠ¶æ…‹ã‚’æ›¸ãæ›ãˆã‚‹ã‚‚ã®ã¨å‹˜é•ã„ 1
   |     ^^^^^^^^^^^^^^^
   |
   = note: `#[warn(unused_must_use)]` (part of `#[warn(unused)]`) on by default
help: use `let _ = ...` to ignore the resulting value
   |
22 |     let _ = options.b(true); // å†…éƒ¨çŠ¶æ…‹ã‚’æ›¸ãæ›ãˆã‚‹ã‚‚ã®ã¨å‹˜é•ã„ 1
   |     +++++++

warning: unused return value of `Options::n` that must be used
  --> src/main.rs:23:5
   |
23 |     options.n(123); // å‹˜é•ã„ 2
   |     ^^^^^^^^^^^^^^
   |
help: use `let _ = ...` to ignore the resulting value
   |
23 |     let _ = options.n(123); // å‹˜é•ã„ 2
   |     +++++++
```

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ä½¿ç”¨ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã‚’è­¦å‘Šã™ã‚‹ãŸã‚ã® `#[must_use]` ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

## å‚è€ƒ

- Diagnostics - The Rust Reference
  <https://doc.rust-lang.org/reference/attributes/diagnostics.html#the-must_use-attribute>
