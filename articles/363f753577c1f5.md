---
emoji: "ğŸ¦”"
publication_name: "doctormate"
published: false
# published_at: 2026-03-02 12:00
title: "axum crate ã® Middleware (1) Middleware ã®é©ç”¨é †åº"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ axum crate ã® ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¦‹ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/0ae1263c351356)ã€‚

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (ã®å‰åŠ) ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.6 ã§ã™ã€‚

## axum ã® middleware

ã¾ãšã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/index.html>

[ç¬¬ä¸€å›ã® axum ã®æ¦‚è¦](https://zenn.dev/doctormate/articles/37c97d448cc218) ã§ã‚‚è§¦ã‚ŒãŸã®ã§ã™ãŒã€ axum ã¯ middleware ã‚’ç‹¬è‡ªã«ã¯æŒãŸãšã€ä»£ã‚ã‚Šã« `tower` ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸ `tower` crate ã®ã‚¬ã‚¤ãƒ‰ã‚’èª­ã‚€ã‚ˆã†ã«ã™ã™ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å®Œå…¨ãªç†è§£ã¯ã›ãšã¨ã‚‚åŸºæœ¬çš„ãªã¨ã“ã‚ã¯ç†è§£ã™ã¹ãã¨ã®ã“ã¨ã§ã™ã€‚ãƒŸãƒ¼ãƒ çš„ã«ã€Œå®Œå…¨ã«ç†è§£ã—ãŸã€ã¯ã‚ã¾ã‚Šå®Œå…¨ã§ã¯ãªã•ãã†ã§ã™ãŒâ€¦â€¦ã€‚

<https://github.com/tower-rs/tower/tree/master/guides>

ã“ã‚Œã¯èª­ã¿å‡ºã™ã¨çµ‚ã‚ã‚‰ãªã„ã®ã§åˆ¥ã®æ©Ÿä¼šã«ã€‚

ã‚ã¨ã¯ `tower::ServiceBuilder` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã“ã¨ã‚‚ã™ã™ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

<https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html>

## Middleware ã®é©ç”¨ç®‡æ‰€

æ¬¡ã¯ Middleware ã®é©ç”¨ç®‡æ‰€ã«ã¤ã„ã¦æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

- Router å˜ä½ã§ã®é©ç”¨ (`Router::layer` ã¨ `Router::route_layer`)
- MethodRouter å˜ä½ã§ã®é©ç”¨ (`MethodRouter::layer` ã¨ `MethodRouter::route_layer`)
- Handler å˜ä½ã§ã®é©ç”¨ (`Handler::layer`)

ã“ã®ã‚ãŸã‚Šã¯ Router ã‚„ Handler ã®å›ã«ã‚‚ã™ã“ã—è¦‹ã¦ã„ã¾ã™ã­ã€‚

## è¤‡æ•° Middleware ã®é©ç”¨ã¨é †åº

è¤‡æ•°ã® Middleware ã®é©ç”¨ã¯ `tower::ServiceBuilder` ã‚’ä½¿ã†ã“ã¨ã‚’ã™ã™ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

è¤‡æ•°ã® Middleware ã®é©ç”¨ã§ã¯ã€ãã®é †åºãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

`Router::layer` ã¯ä¸‹ã‹ã‚‰ä¸Š (å†…å´ã‹ã‚‰å¤–å´) ã®é †ã€‚ã“ã‚Œã¯å¾Œã‹ã‚‰è¶³ã—ãŸã‚‚ã®ã§ wrap ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã¾ã™ã€‚

```rust
use axum::{routing::get, Router};

async fn handler() {}

let app = Router::new()
    .route("/", get(handler))
    .layer(layer_one)
    .layer(layer_two)
    .layer(layer_three);
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹å›³ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã­ã€‚

```text
        requests
           |
           v
+----- layer_three -----+
| +---- layer_two ----+ |
| | +-- layer_one --+ | |
| | |               | | |
| | |    handler    | | |
| | |               | | |
| | +-- layer_one --+ | |
| +---- layer_two ----+ |
+----- layer_three -----+
           |
           v
        responses
```

`tower::ServiceBuilder` ã¯é€†ã®ä¸Šã‹ã‚‰ä¸‹ (å†…å´ã‹ã‚‰å¤–å´) ã®é †ã€‚ã“ã‚Œã¯ç´›ã‚‰ã‚ã—ã„ã§ã™ã­â€¦â€¦ã€‚ã‚ˆã‚Šç›´æ„Ÿçš„ãªé †åºã«ãªã‚‹ã®ã¯ã€ `ServiceBuilder` ã‚’æ¨å¥¨ã™ã‚‹ç†ç”±ã®ã²ã¨ã¤ã¨ã®ã“ã¨ã€‚

```rust
use tower::ServiceBuilder;
use axum::{routing::get, Router};

async fn handler() {}

let app = Router::new()
    .route("/", get(handler))
    .layer(
        ServiceBuilder::new()
            .layer(layer_one)
            .layer(layer_two)
            .layer(layer_three),
    );
```

```text
        requests
           |
           v
+------ layer_one ------+
| +---- layer_two ----+ |
| | +- layer_three -+ | |
| | |               | | |
| | |    handler    | | |
| | |               | | |
| | +- layer_three -+ | |
| +---- layer_two ----+ |
+------ layer_one ------+
           |
           v
        responses
```

## Router::layer ã®å®Ÿè£…

å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

<https://docs.rs/axum/0.8.6/axum/struct.Router.html#method.layer>

```rust
pub fn layer<L>(self, layer: L) -> Router<S>
where
    L: Layer<Route> + Clone + Send + Sync + 'static,
    L::Service: Service<Request> + Clone + Send + Sync + 'static,
    <L::Service as Service<Request>>::Response: IntoResponse + 'static,
    <L::Service as Service<Request>>::Error: Into<Infallible> + 'static,
    <L::Service as Service<Request>>::Future: Send + 'static,
{
    map_inner!(self, this => RouterInner {
        path_router: this.path_router.layer(layer.clone()),
        fallback_router: this.fallback_router.layer(layer.clone()),
        default_fallback: this.default_fallback,
        catch_all_fallback: this.catch_all_fallback.map(|route| route.layer(layer)),
    })
}
```

```rust
macro_rules! map_inner {
    ( $self_:ident, $inner:pat_param => $expr:expr) => {
        #[allow(redundant_semicolons)]
        {
            let $inner = $self_.into_inner();
            Router {
                inner: Arc::new($expr),
            }
        }
    };
}
```

`PathRouter::layer` ã‚’å‘¼ã³å‡ºã—ãŸ `RouterInner` ã§ `Router` ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

`PathRouter::layer` ã®å®Ÿè£…ã¯â€¦â€¦

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/routing/path_router.rs#L285-L308>

```rust
pub(super) fn layer<L>(self, layer: L) -> PathRouter<S, IS_FALLBACK>
where
    L: Layer<Route> + Clone + Send + Sync + 'static,
    L::Service: Service<Request> + Clone + Send + Sync + 'static,
    <L::Service as Service<Request>>::Response: IntoResponse + 'static,
    <L::Service as Service<Request>>::Error: Into<Infallible> + 'static,
    <L::Service as Service<Request>>::Future: Send + 'static,
{
    let routes = self
        .routes
        .into_iter()
        .map(|(id, endpoint)| {
            let route = endpoint.layer(layer.clone());
            (id, route)
        })
        .collect();


    PathRouter {
        routes,
        node: self.node,
        prev_route_id: self.prev_route_id,
        v7_checks: self.v7_checks,
    }
}
```

å„ `Endpoint::layer` ã‚’å‘¼ã³å‡ºã—ãŸ `routes` ã§ `PathRouter` ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

`Endpoint::layer` ã®å®Ÿè£…ã¯â€¦â€¦

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/routing/mod.rs#L761-L775>

```rust
fn layer<L>(self, layer: L) -> Endpoint<S>
where
    L: Layer<Route> + Clone + Send + Sync + 'static,
    L::Service: Service<Request> + Clone + Send + Sync + 'static,
    <L::Service as Service<Request>>::Response: IntoResponse + 'static,
    <L::Service as Service<Request>>::Error: Into<Infallible> + 'static,
    <L::Service as Service<Request>>::Future: Send + 'static,
{
    match self {
        Endpoint::MethodRouter(method_router) => {
            Endpoint::MethodRouter(method_router.layer(layer))
        }
        Endpoint::Route(route) => Endpoint::Route(route.layer(layer)),
    }
}
```

`MethodRouter::layer` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

`MethodRouter::layer` ã®å®Ÿè£…ã¯â€¦â€¦

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/routing/method_routing.rs#L967-L993>

```rust
pub fn layer<L, NewError>(self, layer: L) -> MethodRouter<S, NewError>
where
    L: Layer<Route<E>> + Clone + Send + Sync + 'static,
    L::Service: Service<Request> + Clone + Send + Sync + 'static,
    <L::Service as Service<Request>>::Response: IntoResponse + 'static,
    <L::Service as Service<Request>>::Error: Into<NewError> + 'static,
    <L::Service as Service<Request>>::Future: Send + 'static,
    E: 'static,
    S: 'static,
    NewError: 'static,
{
    let layer_fn = move |route: Route<E>| route.layer(layer.clone());


    MethodRouter {
        get: self.get.map(layer_fn.clone()),
        head: self.head.map(layer_fn.clone()),
        delete: self.delete.map(layer_fn.clone()),
        options: self.options.map(layer_fn.clone()),
        patch: self.patch.map(layer_fn.clone()),
        post: self.post.map(layer_fn.clone()),
        put: self.put.map(layer_fn.clone()),
        trace: self.trace.map(layer_fn.clone()),
        connect: self.connect.map(layer_fn.clone()),
        fallback: self.fallback.map(layer_fn),
        allow_header: self.allow_header,
    }
}
```

`Route::layer` ã‚’å‘¼ã³å‡ºã™ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§ `MethodEndpoint::map` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

`MethodEndpoint::map` ã®å®Ÿè£…ã¯â€¦â€¦ã€‚

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/routing/method_routing.rs#L1243-L1255>

```rust
fn map<F, E2>(self, f: F) -> MethodEndpoint<S, E2>
where
    S: 'static,
    E: 'static,
    F: FnOnce(Route<E>) -> Route<E2> + Clone + Send + Sync + 'static,
    E2: 'static,
{
    match self {
        Self::None => MethodEndpoint::None,
        Self::Route(route) => MethodEndpoint::Route(f(route)),
        Self::BoxedHandler(handler) => MethodEndpoint::BoxedHandler(handler.map(f)),
    }
}
```

`Route::layer` ã®å®Ÿè£…ã¯â€¦â€¦ã€‚

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/routing/route.rs#L60-L73>

```rust
pub(crate) fn layer<L, NewError>(self, layer: L) -> Route<NewError>
where
    L: Layer<Route<E>> + Clone + Send + 'static,
    L::Service: Service<Request> + Clone + Send + Sync + 'static,
    <L::Service as Service<Request>>::Response: IntoResponse + 'static,
    <L::Service as Service<Request>>::Error: Into<NewError> + 'static,
    <L::Service as Service<Request>>::Future: Send + 'static,
    NewError: 'static,
{
    let layer = (MapErrLayer::new(Into::into), layer);


    Route::new(layer.layer(self))
}
```

ã“ã“ã§ã‚ˆã†ã‚„ãå¼•æ•°ãŒå¤–å´ã«ãªã‚‹ wrap ã£ã½ã„å‹•ãã«ãªã£ã¦ã„ãã†ã§ã™ã€‚

è‡ªèº«ã¯å†…å´ã€å¼•æ•°ã¯å¤–å´ã«â€¦â€¦ã¨ã„ã†å‡¦ç†ã«ãªã£ã¦ã„ã¾ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã¯ã€Œå¼•æ•°ã‚’å¤–å´ã«ã€ã§ wrap ã—ã¦ã„ãå½¢ã§ã™ã­ã€‚

## ServiceBuilder::layer ã®å®Ÿè£…

æ¬¡ã¯ `ServiceBuilder::layer` ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

<https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html>

```rust
pub struct ServiceBuilder<L> {
    layer: L,
}
```

```rust
pub fn layer<T>(self, layer: T) -> ServiceBuilder<Stack<T, L>> {
    ServiceBuilder {
        layer: Stack::new(layer, self.layer),
    }
}
```

`Stack::new` ã®ç¬¬ä¸€å¼•æ•°ã«å¼•æ•°ã§å—ã‘å–ã£ãŸ layer ã€ç¬¬äºŒå¼•æ•°ã«è‡ªèº«ã® layer ã‚’æ¸¡ã—ã¦å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

`Stack::new` ã¨ `Stack::layer` ã®å®Ÿè£…ã¯â€¦â€¦

<https://github.com/tower-rs/tower/blob/tower-0.5.2/tower-layer/src/stack.rs#L11-L30>

```rust
impl<Inner, Outer> Stack<Inner, Outer> {
    /// Create a new `Stack`.
    pub const fn new(inner: Inner, outer: Outer) -> Self {
        Stack { inner, outer }
    }
}


impl<S, Inner, Outer> Layer<S> for Stack<Inner, Outer>
where
    Inner: Layer<S>,
    Outer: Layer<Inner::Service>,
{
    type Service = Outer::Service;


    fn layer(&self, service: S) -> Self::Service {
        let inner = self.inner.layer(service);


        self.outer.layer(inner)
    }
}
```

å¼•æ•°ã‚’è‡ªèº«ã‚ˆã‚Šã‚‚å†…å´ã«â€¦â€¦ã‚’ç¹°ã‚Šè¿”ã™å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

å…¨ä½“ã§ã¯ã€Œå¼•æ•°ã‚’å†…å´ã«ã€ã§ã€ä¸€ç•ªå†…å´ã«ã¯ã‚ã“ã‚“ã§ã„ãå½¢ã§ã™ã­ã€‚

## å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹

ã”ã¡ã‚ƒã”ã¡ã‚ƒè€ƒãˆã‚‹ã‚ˆã‚Šå®Ÿéš›ã«æ›¸ã„ã¦ã¿ã‚‹ã¨è‰¯ã„ã§ã™ã­ã€‚

<https://github.com/bouzuya/rust-examples/blob/097e4444669f425712f1693536ce474289800001/axum8/src/main.rs>

å°ã•ã„ä¾‹ã‚’æ›¸ã„ã¦ç¢ºã‹ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã®é †åºã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (å‰åŠ) ã‚’è¦‹ã¾ã—ãŸã€‚ç‰¹ã« `ServiceBuilder::layer` ã‚„ `Router::layer` ã®é©ç”¨é †åºã®é•ã„ã«æ³¨ç›®ã—ã¾ã—ãŸã€‚

æ¬¡å›ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¾ŒåŠã§ã€ Middleware ã‚’æ›¸ã„ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
