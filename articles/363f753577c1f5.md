---
emoji: "🦔"
publication_name: "doctormate"
published: true
published_at: 2026-03-02 12:00
title: "axum crate の middleware"
topics: ["rust"]
type: "tech"
---

[前回は axum crate の エラーハンドリングを見ました](https://zenn.dev/doctormate/articles/0ae1263c351356)。

今回は axum の middleware のドキュメント (の前半) を見ていきます。

今回も axum crate のバージョンは 0.8.4 です。

## axum の middleware

まずはドキュメントを見ていきます。

<https://docs.rs/axum/0.8.4/axum/middleware/index.html>

[第一回の axum の概要](https://zenn.dev/doctormate/articles/37c97d448cc218) でも触れたのですが、 axum は middleware を独自には持たず、代わりに `tower` を使っていることが書かれています。

また `tower` crate のガイドを読むようにすすめられています。完全な理解はせずとも基本的なところは理解すべきとのことです。ミーム的に「完全に理解した」はあまり完全ではなさそうですが……。

<https://github.com/tower-rs/tower/tree/master/guides>

これは読み出すと終わらないので別の機会に。

あとは `tower::ServiceBuilder` のドキュメントを読むこともすすめられています。

<https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html>

## Middleware の適用箇所

次は Middleware の適用箇所について書いてあります。

- Router 単位での適用 (`Router::layer` と `Router::route_layer`)
- MethodRouter 単位での適用 (`MethodRouter::layer` と `MethodRouter::route_layer`)
- Handler 単位での適用 (`Handler::layer`)

このあたりは Router や Handler の回でもすこしは見ていますね。

## 複数 Middleware の適用と順序

複数の Middleware の適用は `tower::ServiceBuilder` を使うことをすすめられています。

続いて順序。 `Router::layer` は後から足したもので wrap されるので、下から上 (厳密には内から外) の順。 `tower::ServiceBuilder` は逆に上から下の順。これは紛らわしいですね……。

より直感的な順序になっている `tower::ServiceBuilder` を推奨するとのこと。

ドキュメントには図があるので、そちらも分かりやすいかもしれません。

## Middleware の作成 (WIP)

- `axum::middleware::from_fn`
- `axum::middleware::from_extractor`
- `tower::ServiceBuilder::map_request`
- `tower::ServiceBuilder::map_response`
- `tower::ServiceBuilder::then`
- `tower::ServiceBuilder::and_then`
- `tower::Service` (最大の制御)

<https://github.com/tower-rs/tower/blob/master/guides/building-a-middleware-from-scratch.md>

## おわりに

TODO
