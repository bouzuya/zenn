---
emoji: "ï¸ğŸª—"
publication_name: "doctormate"
published: false
# published_at: 2025-09-11 12:00
title: "cargo-expand ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†"
topics: ["rust"]
type: "tech"
---

# `cargo-expand` ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†

[å‰å›ã¯ `thiserror` crate ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸ][zenn:8305782244b7f4] ã€‚ä»Šå›ã¯ [`cargo-expand`][dtolnay/cargo-expand] ã®ä½¿ã„æ–¹ã‚’ç¢ºèªã—ã¤ã¤ã€ `thiserror` crate ã®æä¾›ã™ã‚‹ derive macro ã®å±•é–‹çµæœã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## `cargo-expand` ã¨ã¯

`cargo-expand` ã¯ macro ã®å±•é–‹çµæœã‚’å‡ºåŠ›ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

<https://github.com/dtolnay/cargo-expand>

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

`cargo install cargo-expand`

README ã«ã‚ˆã‚‹ã¨ `rustfmt` ã‚‚ã‚ã‚Œã°ä½¿ã†ã‚‰ã—ã„ã§ã™ã€‚ `cargo` ãŒå…¥ã£ã¦ã„ã¦ `rustfmt` ãŒå…¥ã£ã¦ã„ãªã„ç’°å¢ƒã¯ãã‚“ãªã«ãªã„ã¯ãšâ€¦â€¦ (çŸ¥ã‚‰ãªã„) ã€‚

## README ã®ä¾‹

README ã®ä¾‹ã‚’ãã®ã¾ã¾å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã€‚

```rust
#[derive(Debug)]
struct S;

fn main() {
    println!("{:?}", S);
}
```

`cargo expand`

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
struct S;
#[automatically_derived]
impl ::core::fmt::Debug for S {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::write_str(f, "S")
    }
}
fn main() {
    {
        ::std::io::_print(format_args!("{0:?}\n", S));
    };
}
```

ã¡ã‚‡ã£ã¨ README ã¨ã¯é•ã†çµæœã§ã™ã‘ã©ã€ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®é•ã„ãªã©ã«ã‚ˆã‚‹ã‚‚ã®ã§ã—ã‚‡ã†ã€‚

å¤§åˆ‡ãªã®ã¯ `#[derive(Debug)]` ã‚„ `println!` ã®å±•é–‹ã•ã‚ŒãŸçµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

## ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

`cargo expand --help` ã—ã¦ãã ã•ã„ã€‚çœç•¥ã€‚

# å‰å›ã®è¨˜äº‹ã®ä¾‹

ã•ã¦ã€æœ¬é¡Œã€‚å‰å›ã® `thiserror` ã®è¨˜äº‹ã®ä¾‹ã«å¯¾ã—ã¦ `cargo expand` ã—ã¦å±•é–‹ã—ãŸçµæœã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## å‰å›ã®è¨˜äº‹ã®ä¾‹ 1

ã¾ãšã¯ã“ã‚Œã€‚

```rust
#[derive(Debug, thiserror::Error)]
#[error("unit struct error")]
struct UnitStructError;
```

`cargo expand` ã™ã‚‹ã¨â€¦â€¦

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
#[error("unit struct error")]
struct UnitStructError;
#[automatically_derived]
impl ::core::fmt::Debug for UnitStructError {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::write_str(f, "UnitStructError")
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::thiserror::__private::Error for UnitStructError {}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::core::fmt::Display for UnitStructError {
    #[allow(clippy::used_underscore_binding)]
    fn fmt(&self, __formatter: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        #[allow(unused_variables, deprecated)]
        let Self {} = self;
        __formatter.write_str("unit struct error")
    }
}
```

`#[derive(...)]` ã¯ãªããªã‚‹ã‚‚ã®ã® `#[error("...")]` ã¯æ¶ˆãˆãªã„ã¿ãŸã„ã§ã™ã­ã€‚

`#[derive(...)]` ã®å±•é–‹çµæœã¯ `#[automatically_derived]` ãŒä»˜ãã‚“ã§ã™ã‹ã­ã€‚

ã¾ãšã¯ `Debug` trait ã®å®Ÿè£…ã€‚ã“ã‚Œã¯å‰²æ„›ã—ã¾ã™ã€‚ã¾ãŸ `Debug` trait ã®ã“ã¨ã‚‚ãã®ã†ã¡æ›¸ãã¨æ€ã†ã®ã§ã€ãã®ã¨ãã«ã§ã‚‚ã€‚

æ¬¡ã¯ `impl ::thiserror::__private::Error for TupleStructError` ã§ã™ã­ã€‚ `::thiserror::__private::Error` ã£ã¦ãªã‚“ã ã‚ˆã£ã¦è©±ã§ã™ã‘ã©ã€ <https://github.com/dtolnay/thiserror/blob/7a5fbc65c03e39eed9a3fd2cd48e4313178734ed/src/lib.rs#L299> ã¨ã„ã† `thiserror` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚Œã° `std::error::Error` ã‚’ re-export ã—ãŸã‚‚ã®ã ã¨åˆ†ã‹ã‚Šã¾ã™ã€‚ä¸­èº«ã¯ç©ºã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè£…ã‚’ä½¿ã†ã ã‘ã®ã‚‚ã®ã§ã™ã­ã€‚

ãã—ã¦ `Display` trait ã®å®Ÿè£…ã€‚ `formatter` ã® `write_str` ã« `#[error("...")]` ã§æŒ‡å®šã—ãŸå†…å®¹ã‚’æ›¸ã„ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚

æœŸå¾…é€šã‚Šã®å‡ºåŠ›ã§ã™ã­ã€‚

## å‰å›ã®è¨˜äº‹ã®ä¾‹ 2

æ¬¡ã¯ã©ã†ã§ã—ã‚‡ã†ã€‚

```rust
#[derive(Debug, thiserror::Error)]
#[error("tuple struct error: {0}")]
struct TupleStructError(#[from] std::io::Error);
```

`cargo expand` ã™ã‚‹ã¨â€¦â€¦

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
#[error("tuple struct error: {0}")]
struct TupleStructError(#[from] std::io::Error);
#[automatically_derived]
impl ::core::fmt::Debug for TupleStructError {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_tuple_field1_finish(
            f,
            "TupleStructError",
            &&self.0,
        )
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::thiserror::__private::Error for TupleStructError {
    fn source(
        &self,
    ) -> ::core::option::Option<&(dyn ::thiserror::__private::Error + 'static)> {
        use ::thiserror::__private::AsDynError as _;
        ::core::option::Option::Some(self.0.as_dyn_error())
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::core::fmt::Display for TupleStructError {
    #[allow(clippy::used_underscore_binding)]
    fn fmt(&self, __formatter: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        use ::thiserror::__private::AsDisplay as _;
        #[allow(unused_variables, deprecated)]
        let Self(_0) = self;
        match (_0.as_display(),) {
            (__display0,) => {
                __formatter
                    .write_fmt(format_args!("tuple struct error: {0}", __display0))
            }
        }
    }
}
#[allow(
    deprecated,
    unused_qualifications,
    clippy::elidable_lifetime_names,
    clippy::needless_lifetimes,
)]
#[automatically_derived]
impl ::core::convert::From<std::io::Error> for TupleStructError {
    fn from(source: std::io::Error) -> Self {
        TupleStructError { 0: source }
    }
}
```

`#[from]` ã‚‚ `#[error("...")]` ã¨åŒæ§˜ã«æ®‹ã£ã¦ã„ã¾ã™ã€‚

`Debug` trait ã®å®Ÿè£…ã¯å‰²æ„›ã€‚

`Error` trait ã®å®Ÿè£…ã€‚ `#[from]` ãŒ `#[source]` ã‚’å…¼ã­ã‚‹ã“ã¨ã‹ã‚‰ãã¡ã‚“ã¨ `source` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã­ã€‚ `source` ã®å®Ÿè£…ã§ã¯ `self.0` ã‚’ `::thiserror::__private::AsDynError` ã¨ã—ã¦ `.as_dyn_error()` ã‚’å‘¼ã³ã€ãã‚Œã‚’è¿”ã—ã¦ã„ã¾ã™ã­ã€‚åå‰ã‚„å‹ã‹ã‚‰ `dyn Error` ã®å‚ç…§ã‚’å¾—ã‚‹ã‚‚ã®ã§ã™ã­ã€‚

`Display` trait ã®å®Ÿè£…ã€‚ `self.0` ã‚’ `::thiserror::__private::AsDisplay` ã¨ã—ã¦ `.as_display()` ã‚’å‘¼ã³ã€ `#[error("...")]` ã§æŒ‡å®šã—ãŸæ–‡å­—åˆ—ã®å½¢å¼ã« `.write_fmt(format_args!(...), ...)` ã—ã¦ã„ã¾ã™ã­ã€‚

ãã—ã¦ `From` trait ã®å®Ÿè£…ã€‚ `#[from]` ã§æŒ‡å®šã—ãŸå‹ã‹ã‚‰ `from` ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãã‚Œã¦ã„ã¾ã™ã­ã€‚

ã„ã„ã§ã™ã­ã€‚

## å‰å›ã®è¨˜äº‹ã®ä¾‹ 3

ã©ã‚“ã©ã‚“è¡Œãã¾ã—ã‚‡ã†ã€‚æ¬¡ã¯ã“ã‚Œã§ã™ã€‚

```rust
#[derive(Debug, thiserror::Error)]
#[error("struct error: {cause:?}")]
struct StructError {
    #[source]
    cause: std::io::Error,
}
```

`cargo expand` ã™ã‚‹ã¨â€¦â€¦

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
#[error("struct error: {cause:?}")]
struct StructError {
    #[source]
    cause: std::io::Error,
}
#[automatically_derived]
impl ::core::fmt::Debug for StructError {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(
            f,
            "StructError",
            "cause",
            &&self.cause,
        )
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::thiserror::__private::Error for StructError {
    fn source(
        &self,
    ) -> ::core::option::Option<&(dyn ::thiserror::__private::Error + 'static)> {
        use ::thiserror::__private::AsDynError as _;
        ::core::option::Option::Some(self.cause.as_dyn_error())
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::core::fmt::Display for StructError {
    #[allow(clippy::used_underscore_binding)]
    fn fmt(&self, __formatter: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        #[allow(unused_variables, deprecated)]
        let Self { cause } = self;
        match (cause,) {
            (__field_cause,) => {
                __formatter.write_fmt(format_args!("struct error: {0:?}", __field_cause))
            }
        }
    }
}
```

`Debug` trait ã®å®Ÿè£…ã¯å‰²æ„›ã€‚

`Error` trait ã®å®Ÿè£…ã¯ä¾‹ 2 ã¨å¤‰ã‚ã‚‰ãšã€‚ `#[source]` ãŒã¤ã„ã¦ã„ã‚‹ã‹ã‚‰ `.source()` ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚

`Display` trait ã®å®Ÿè£…ã¯ format ãŒ `{0:?}` ã«ãªã£ãŸãã‚‰ã„ã§ã™ã­ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å±•é–‹ãªã©ã¯ thiserror ã®å®Ÿè£…ãŒã„ã‚ã„ã‚ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ (ãã¡ã‚“ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯è¿½ã£ã¦ã„ãªã„ã®ã§æƒ³åƒã§ã™ãŒ) ã€‚å±•é–‹å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯ç´ æœ´ã§ã™ã­ã€‚

`#[from]` ãŒãªã„ã®ã§ `From` trait ã®å®Ÿè£…ã¯ãªãã€ã‚„ã‚„ã‚¹ãƒƒã‚­ãƒªã—ã¦ã„ã¾ã™ã­ã€‚

## å‰å›ã®è¨˜äº‹ã®ä¾‹ 4

æœ€å¾Œã®ä¾‹ã§ã™ã­ã€‚

```rust
#[derive(Debug, thiserror::Error)]
enum EnumError {
    #[error("io error")]
    Io(#[source] std::io::Error),
    #[error(transparent)]
    From(#[from] Box<dyn std::error::Error + Send + Sync>),
    #[error(transparent)]
    Unknown(Box<dyn std::error::Error + Send + Sync>),
}
```

`cargo expand` ã™ã‚‹ã¨â€¦â€¦

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
enum EnumError {
    #[error("io error")]
    Io(#[source] std::io::Error),
    #[error(transparent)]
    From(#[from] Box<dyn std::error::Error + Send + Sync>),
    #[error(transparent)]
    Unknown(Box<dyn std::error::Error + Send + Sync>),
}
#[automatically_derived]
impl ::core::fmt::Debug for EnumError {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        match self {
            EnumError::Io(__self_0) => {
                ::core::fmt::Formatter::debug_tuple_field1_finish(f, "Io", &__self_0)
            }
            EnumError::From(__self_0) => {
                ::core::fmt::Formatter::debug_tuple_field1_finish(f, "From", &__self_0)
            }
            EnumError::Unknown(__self_0) => {
                ::core::fmt::Formatter::debug_tuple_field1_finish(
                    f,
                    "Unknown",
                    &__self_0,
                )
            }
        }
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::thiserror::__private::Error for EnumError {
    fn source(
        &self,
    ) -> ::core::option::Option<&(dyn ::thiserror::__private::Error + 'static)> {
        use ::thiserror::__private::AsDynError as _;
        #[allow(deprecated)]
        match self {
            EnumError::Io { 0: source, .. } => {
                ::core::option::Option::Some(source.as_dyn_error())
            }
            EnumError::From { 0: transparent } => {
                ::thiserror::__private::Error::source(transparent.as_dyn_error())
            }
            EnumError::Unknown { 0: transparent } => {
                ::thiserror::__private::Error::source(transparent.as_dyn_error())
            }
        }
    }
}
#[allow(unused_qualifications)]
#[automatically_derived]
impl ::core::fmt::Display for EnumError {
    fn fmt(&self, __formatter: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        #[allow(unused_variables, deprecated, clippy::used_underscore_binding)]
        match self {
            EnumError::Io(_0) => __formatter.write_str("io error"),
            EnumError::From(_0) => ::core::fmt::Display::fmt(_0, __formatter),
            EnumError::Unknown(_0) => ::core::fmt::Display::fmt(_0, __formatter),
        }
    }
}
#[allow(
    deprecated,
    unused_qualifications,
    clippy::elidable_lifetime_names,
    clippy::needless_lifetimes,
)]
#[automatically_derived]
impl ::core::convert::From<Box<dyn std::error::Error + Send + Sync>> for EnumError {
    fn from(source: Box<dyn std::error::Error + Send + Sync>) -> Self {
        EnumError::From { 0: source }
    }
}
```

`Debug` trait ã®å®Ÿè£…ã€‚å‰²æ„›ã€‚

`Error` trait ã®å®Ÿè£…ã€‚ `match` ã§ variant ã”ã¨ã«åˆ†ã‘ã¦ã„ã¾ã™ã­ã€‚ `#[transparent]` ã«ã¤ã„ã¦ã¯ `Some(source.as_dyn_error())` ã¨ã›ãš `Error::source(transparent.as_dyn_error())` ã¨ã—ã¦ã€ä¸­èº«ã® `Error` ã«ä¸¸æŠ•ã’ã—ã¦ã„ã¾ã™ã­ã€‚ç¢ºã‹ã«é€éçš„ã§ã™ã€‚

`Display` trait ã®å®Ÿè£…ã€‚ã“ã¡ã‚‰ã‚‚ `match` ã§ variant ã”ã¨ã«åˆ†ã‘ã¦ã„ã¾ã™ã­ã€‚ã“ã¡ã‚‰ã‚‚ `#[transparent]` ã«ã¤ã„ã¦ `Display::fmt(_0, __formatter)` ã¨ã—ã¦ä¸¸æŠ•ã’ã—ã¦ã„ã¾ã™ã­ã€‚ã†ã‚“ã†ã‚“ã€‚

`From` trait ã®å®Ÿè£…ã€‚ `#[from]` ã‚’ã¤ã‘ãŸã®ã§ã“ã‚Œã‚‚ã‚ã‚Šã¾ã™ã­ã€‚ `#[from]` ã‚’ä»˜ã‘ãŸ `EnumError::From` variant ãŒãã¡ã‚“ã¨æŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚‚ã†è¦‹æ…£ã‚Œã¦ãã¾ã—ãŸã­ã€‚

## ãŠã‚ã‚Š

`cargo-expand` ã®ç´¹ä»‹ã¨ã€ãã‚Œã‚’ä½¿ã£ã¦å‰å›ã® `thiserror` ã®è¨˜äº‹ã®ä¾‹ã® macro ã‚’å±•é–‹ã—ã¦ã¿ã¾ã—ãŸã€‚

macro ã¯ä½•ãŒèµ·ãã‚‹ã‹ãƒ‘ãƒƒã¨è¦‹ã§ã¯åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€ã‚ˆãä½¿ã†ã‚‚ã®ãã‚‰ã„ã¯å±•é–‹ã•ã‚ŒãŸä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ãƒ»ç†è§£ã—ã¦ã¿ã‚‹ã¨é¢ç™½ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

[dtolnay/cargo-expand]: https://github.com/dtolnay/cargo-expand
[zenn:8305782244b7f4]: https://zenn.dev/doctormate/articles/8305782244b7f4
