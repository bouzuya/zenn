---
emoji: "ğŸš—"
publication_name: "doctormate"
published: true
published_at: 2026-01-05 12:00
title: "axum crate ã® Handler"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ axum crate ã® `Router::merge` ã¨ `Router::nest` ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸ](https://zenn.dev/doctormate/articles/504f941834f245)ã€‚

ä»Šå›ã¯ [axum crate](https://crates.io/crates/axum) ã® Handler ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.4 ã§ã™ã€‚

## Handler ã¨ã¯ä½•ã‹ï¼Ÿ

axum crate ã«ãŠã‘ã‚‹ Handler ã¯ 0 å€‹ä»¥ä¸Šã® Extractor ã‚’å¼•æ•°ã«å–ã‚Šã€ `IntoResponse` trait ã®å®Ÿè£…ã‚’è¿”ã™ã€éåŒæœŸé–¢æ•°ã§ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ handle ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

å‰å›ã¾ã§ã«æ›¸ã„ã¦ããŸ `Router` ã¯ã€ã‚ã‚‹ãƒ‘ã‚¹ãƒ»ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ Handler ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ã‚‚ã®ã§ã—ãŸã€‚ 

## Handler ã®ä½¿ã„æ–¹

ã‹ã‚“ãŸã‚“ãª Handler ã®ä½¿ã„æ–¹ã‚’è¦‹ã¾ã™ã€‚ `handler` mod ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ä¾‹ (ä¸€éƒ¨æ”¹å¤‰) ã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/handler/index.html>

```rust
// Handler that immediately returns an empty `200 OK` response.
async fn unit_handler() {}

// Handler that immediately returns a `200 OK` response with a plain text
// body.
async fn string_handler() -> String {
    "Hello, World!".to_string()
}

// Handler that buffers the request body and returns it.
//
// This works because `Bytes` implements `FromRequest`
// and therefore can be used as an extractor.
//
// `String` and `StatusCode` both implement `IntoResponse` and
// therefore `Result<String, StatusCode>` also implements `IntoResponse`
async fn echo(body: axum::body::Bytes) -> Result<String, axum::http::StatusCode> {
    if let Ok(string) = String::from_utf8(body.to_vec()) {
        Ok(string)
    } else {
        Err(axum::http::StatusCode::BAD_REQUEST)
    }
}
```

å¼•æ•°ã‚‚æˆ»ã‚Šå€¤ã‚‚ãªã„ (`()` ã‚’è¿”ã™) å ´åˆã¯ 200 OK æ‰±ã„ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚ [`()` ã¯ `IntoResponse` trait ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™](https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/response/into_response.rs#L126-L130)ã€‚

å¼•æ•°ãŒãªãã€æ–‡å­—åˆ—ã‚’è¿”ã™å ´åˆã¯ 200 OK ã§ plain text ã¨ã—ã¦æ–‡å­—åˆ—ã‚’è¿”ã™ã‚ˆã†ã§ã™ã€‚[æ–‡å­—åˆ— (`String`) ã¯ `IntoResponse` trait ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹](https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/response/into_response.rs#L179-L183)ã®ã§ã€ã“ã‚Œã§è‰¯ã„ã‚ã‘ã§ã™ã€‚

æœ€å¾Œã¯å¼•æ•°ã« `axum::body::Bytes` ã‚’å–ã‚Šã€ `Result<String, StatusCode>` ã‚’è¿”ã™å ´åˆã§ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã¨ãŠã‚Š [`axum::body::Bytes` ã¯ `FromRequest` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Š](https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/extract/request_parts.rs#L98-L114) Extractor ã§ã™ã€‚ã“ã¡ã‚‰ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã¨ãŠã‚Š [`Result<impl IntoResponse, impl IntoResponse>` ã¯ `IntoResponse` ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™](https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/response/into_response.rs#L138-L149)ã—ã€ `String` ã‚‚ `IntoResponse` ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã—ã€ [`StatusCode` ã‚‚ `IntoResponse` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Š](https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum-core/src/response/into_response.rs#L118-L124)ã€æˆ»ã‚Šå€¤ã‚‚ `IntoResponse` ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ä¾‹ã¨èª¬æ˜ã‹ã‚‰åˆ†ã‹ã‚‹ã¨ãŠã‚Š `IntoResponse` ã•ãˆå®Ÿè£…ã—ã¦ã„ã‚Œã° `Result<T, E>` ã§ã‚‚ã„ã„ã®ã§ã€ç‹¬è‡ªã®ã‚¨ãƒ©ãƒ¼å‹ã‚‚ `?` ã‚‚ä½¿ãˆã¾ã™ã€‚

## Handler ã®ãƒ«ãƒ¼ãƒ«

ãŠãŠã¾ã‹ã« Handler ãŒã©ã®ã‚ˆã†ãªã‚‚ã®ã‹åˆ†ã‹ã£ãŸã¨ã“ã‚ã§ã€ã‚‚ã†ã™ã“ã—è©³ã—ãèª¿ã¹ã¦ã„ãã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ Handler ã«ãªã‚‹ãŸã‚ã®ãƒ«ãƒ¼ãƒ«ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/handler/index.html#debugging-handler-type-errors>

> - Are async fns.
> - Take no more than 16 arguments that all implement Send.
>      - All except the last argument implement FromRequestParts.
>      - The last argument implements FromRequest.
> - Returns something that implements IntoResponse.
> - If a closure is used it must implement Clone + Send and be 'static.
> - Returns a future that is Send. The most common way to accidentally make a future !Send is to hold a !Send type across an await.

ä½¿ã£ã¦ã¿ã‚‹ã¨åˆ†ã‹ã‚‹ã®ã§ã™ãŒã€ Handler ã§ãªããªã£ã¦ã—ã¾ã†ã“ã¨ãŒã¾ã¾ã‚ã‚Šã¾ã™ã€‚ãã®ã¨ãã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã€Œ `Handler` trait ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã€ã¨ã„ã†æ—¨ã®ã‚‚ã®ã«ãªã£ã¦ã—ã¾ã„ã€åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ã€‚

ãã®å•é¡Œã®è§£æ±ºã®ãŸã‚ã« `axum-macros` crate ã® `debug_handler` proc macro ã®ç´¹ä»‹ã‚‚ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€ã¼ãã¯ã“ã‚Œã§ã€ŒåŠ©ã‹ã£ãŸï¼ã€ã¨ãªã£ãŸã“ã¨ãŒãªã„ã§ã™â€¦â€¦ã€‚

## Handler trait

æ”¹ã‚ã¦ã§ã™ãŒã€ Handler ã¯ `Handler` trait ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚

å…ˆã®ãƒ«ãƒ¼ãƒ«ã¯ `Handler` trait ã‚„ãã®ãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆå®Ÿè£…ã‚’ã©ã†ã—ã¦ã„ã‚‹ã®ã‹ã‚’ç¤ºã—ãŸã‚‚ã®ã§ã™ã€‚ã‹ã‚“ãŸã‚“ãª Handler ã®ä½¿ã„æ–¹ã§æŒ™ã’ãŸé–¢æ•°ã‚‚ `Handler` trait ã®ãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆå®Ÿè£…ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ Handler ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹ã‚ã‘ã§ã™ã­ã€‚

`Handler` trait ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/handler/trait.Handler.html>

```rust
pub trait Handler<T, S>:
    Clone
    + Send
    + Sync
    + Sized
    + 'static {
    type Future: Future<Output = Response> + Send + 'static;

    // Required method
    fn call(self, req: Request, state: S) -> Self::Future;

    // Provided methods
    fn layer<L>(self, layer: L) -> Layered<L, Self, T, S>
       where L: Layer<HandlerService<Self, T, S>> + Clone,
             L::Service: Service<Request> { ... }
    fn with_state(self, state: S) -> HandlerService<Self, T, S> { ... }
}
```

`call` ã¯ã„ã‚ã‚†ã‚‹å‘¼ã³å‡ºã—ã§ã™ã­ã€‚

`layer` ã¯ `Handler` ã« `layer` ã‚’é©ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã¾ãŸ Middleware ã‚’è¦‹ã‚‹ã¨ãã«å‡ºã¦ããã†ã§ã™ã€‚

`with_state` ã¯ `State` ã‚’è¨­å®šã—ã¦ `Service` ã«ã™ã‚‹ã‚‚ã®ã§ã™ã­ã€‚ [`HandlerWithoutStateExt::into_service`](https://docs.rs/axum/0.8.4/axum/handler/trait.HandlerWithoutStateExt.html#tymethod.into_service) ã§ã‚‚ `Service` ã«ã™ã‚‹ã“ã¨ã¯ã§ããã†ã§ã™ã€‚

Handler ã«ã¯ `layer` ã§ middleware ãŒè¨­å®šã§ãã‚‹ã‚ã‘ã§ã™ã­ã€‚ã¼ãã¯ä¸€åº¦ `Service` ã‚„ `Router` ã«è¿½åŠ ã—ãªã„ã¨ã„ã‘ãªã„ã‚‚ã®ã¨æ€ã„è¾¼ã‚“ã§ã„ã¾ã—ãŸã€‚

## é–¢æ•°ã§ãªã„ Handler

`Handler` trait ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»–ã«ã‚‚é¢ç™½ã„ã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

<https://docs.rs/axum/0.8.4/axum/handler/trait.Handler.html#handlers-that-arent-functions>

`T: IntoResponse` ã«ã‚‚ `Handler` ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯é€šå¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã™ã‚ˆã†ãªå€¤ãã‚Œè‡ªèº«ã‚‚ Handler ã¨ã„ã†ã“ã¨ã§ã™ã€‚

`"Hello, World!"` ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚‚ã€ `StatusCode::CREATED` ã¿ãŸã„ãªã‚‚ã®ã‚‚ Handler ãªã‚“ã§ã™ã­ã€‚

ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸæ©Ÿèƒ½ã§ã™ã€‚

## ãŠã‚ã‚Šã«

`Handler` ã®æ¦‚è¦ã‚„ã‹ã‚“ãŸã‚“ãªä¾‹ã‚’èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

æ¬¡å›ã¯ `Handler` ã®å®Ÿè£…ã‚’ã‚‚ã†ã™ã“ã—è¿½ã„ã‹ã‘ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
