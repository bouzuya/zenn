---
emoji: "ğŸ›"
publication_name: "doctormate"
published: true
published_at: 2025-11-10 12:00
title: "Debug ãƒˆãƒ¬ã‚¤ãƒˆã® derive å±æ€§ã§ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚ˆã†"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ `trybuild` crate ã§ derive macro ã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¾ã—ãŸ][zenn:2832eb691f8fbe]ã€‚ä»Šå›ã¯åŸºæœ¬ã«ç«‹ã¡è¿”ã£ã¦ `Debug` trait ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚ç‰¹ã« derive å±æ€§ã§ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

## `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã¨ã¯

`Debug` ã¯ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒã§ãã‚‹ã“ã¨ã‚’è¡¨ã™ãƒˆãƒ¬ã‚¤ãƒˆã§ã™ã€‚ `std::fmt::Debug` ã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

<https://doc.rust-lang.org/std/fmt/trait.Debug.html>

è¦ã™ã‚‹ã« `format!("{:?}", o)` ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚ `format!("{:#?}", o)` ã‚‚ã§ãã¾ã™ã€‚ `{:#?}` ã¯ pritty-print ã§ã™ã€‚

ã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã§ã¯ `struct` ã‚„ `enum` ã« `#[derive(Debug)]` ã¨ã¤ã‘ã‚‹ã“ã¨ã§å®Ÿè£…ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‡ºåŠ›ã«å«ã¾ã‚Œã‚‹ã¨ã¾ãšã„ã‚±ãƒ¼ã‚¹ãªã©ã§æ‰‹å‹•ã§ã®å®Ÿè£…ã‚’é¸æŠã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä¸€å¿œãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ derive ã§å®Ÿè£…ã—ãŸéš›ã« `struct` ã®å ´åˆã¯ã“ã†å‡ºåŠ›ã•ã‚Œã€ `enum` ã®å ´åˆã“ã†å‡ºåŠ›ã•ã‚Œã‚‹â€¦â€¦ã®ã‚ˆã†ãªã“ã¨ãŒæ›¸ã„ã¦ã‚ã‚‹ã‚‚ã®ã®ã€ not stable ã¨ã‚‚æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã®å½¢å¼ã«ä¾å­˜ã™ã‚‹ã‚ˆã†ãªã“ã¨ã¯ã‚„ã‚ãŸã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚

æä¾›ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `fmt` ã®ã¿ã€‚ã“ã‚Œã¯ `Display` trait ã¨ã‚‚ã‚ˆãä¼¼ã¦ã„ã¾ã™ã­ã€‚ [`Display` trait ã«ã¤ã„ã¦ã¯å¼Šç¤¾ã®é–‹ç™ºãƒ¡ãƒ³ãƒãƒ¼ãŒæ›¸ã„ã¦ã„ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/dive_1_display_trait)ã­ã€‚

## derive å±æ€§ã§ã®å®Ÿè£…

`#[derive(Debug)]` ã§å®Ÿè£…ã—ãŸã¨ãã®å‹•ä½œã‚’èª¿ã¹ã¦ã„ãã¾ã™ã€‚

ã–ã£ã¨å‹•ä½œã‚’ç¢ºèªã—ã€ `cargo expand` ã—ã¦ã¿ã¦ã€ãã‚Œãã‚Œã®å‹ã®çµæœã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### ã–ã£ã¨å‹•ä½œã‚’ç¢ºèª

```rust
#[derive(Debug)]
struct Unit;

#[derive(Debug)]
struct Tuple1(());

#[derive(Debug)]
struct Tuple2(bool, i32);

#[derive(Debug)]
struct Struct1 {
    s: String,
}

#[derive(Debug)]
struct Struct2 {
    nested: Struct1,
}

#[derive(Debug)]
enum Enum {
    Unit,
    Tuple(bool),
    Struct { n: i32 },
}

fn main() {
    let s = Unit;
    assert_eq!(format!("{:?}", s), "Unit");

    let s = Tuple1(());
    assert_eq!(format!("{:?}", s), "Tuple1(())");

    let s = Tuple2(true, 123);
    assert_eq!(format!("{:?}", s), "Tuple2(true, 123)");

    let s = Struct1 {
        s: "abc".to_owned(),
    };
    assert_eq!(format!("{:?}", s), "Struct1 { s: \"abc\" }");

    let s = Struct2 { nested: s };
    assert_eq!(
        format!("{:?}", s),
        "Struct2 { nested: Struct1 { s: \"abc\" } }"
    );

    let s = Enum::Unit;
    assert_eq!(format!("{:?}", s), "Unit");
    let s = Enum::Tuple(true);
    assert_eq!(format!("{:?}", s), "Tuple(true)");
    let s = Enum::Struct { n: 123 };
    assert_eq!(format!("{:?}", s), "Struct { n: 123 }");
}
```

### cargo expand

ä»¥ä¸‹ã¯å‰è¿°ã®ã‚³ãƒ¼ãƒ‰ã‚’ [`cargo expand`][zenn:4d591d072253ca] ã—ãŸçµæœã‹ã‚‰æŠœç²‹ã—ãŸã‚‚ã®ã€‚

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2024::*;
#[macro_use]
extern crate std;
struct Unit;
#[automatically_derived]
impl ::core::fmt::Debug for Unit {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::write_str(f, "Unit")
    }
}
struct Tuple1(());
#[automatically_derived]
impl ::core::fmt::Debug for Tuple1 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_tuple_field1_finish(f, "Tuple1", &&self.0)
    }
}
struct Tuple2(bool, i32);
#[automatically_derived]
impl ::core::fmt::Debug for Tuple2 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_tuple_field2_finish(f, "Tuple2", &self.0, &&self.1)
    }
}
struct Struct1 {
    s: String,
}
#[automatically_derived]
impl ::core::fmt::Debug for Struct1 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(f, "Struct1", "s", &&self.s)
    }
}
struct Struct2 {
    nested: Struct1,
}
#[automatically_derived]
impl ::core::fmt::Debug for Struct2 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(
            f,
            "Struct2",
            "nested",
            &&self.nested,
        )
    }
}
enum Enum {
    Unit,
    Tuple(bool),
    Struct { n: i32 },
}
#[automatically_derived]
impl ::core::fmt::Debug for Enum {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        match self {
            Enum::Unit => ::core::fmt::Formatter::write_str(f, "Unit"),
            Enum::Tuple(__self_0) => {
                ::core::fmt::Formatter::debug_tuple_field1_finish(f, "Tuple", &__self_0)
            }
            Enum::Struct { n: __self_0 } => {
                ::core::fmt::Formatter::debug_struct_field1_finish(
                    f,
                    "Struct",
                    "n",
                    &__self_0,
                )
            }
        }
    }
}
```

### unit struct

ãã‚Œãã‚Œã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

```rust
#[derive(Debug)]
struct Unit;
```

```rust
struct Unit;
#[automatically_derived]
impl ::core::fmt::Debug for Unit {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::write_str(f, "Unit")
    }
}
```

`write_str` ã§è­˜åˆ¥å­ã‚’è¿”ã™ã®ã¿ã§ã€ç‰¹ã«è¨€ã†ã“ã¨ã¯ãªã„ã§ã™ã­ã€‚

### tuple struct

```rust
#[derive(Debug)]
struct Tuple1(());

#[derive(Debug)]
struct Tuple2(bool, i32);
```

```rust
struct Tuple1(());
#[automatically_derived]
impl ::core::fmt::Debug for Tuple1 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_tuple_field1_finish(f, "Tuple1", &&self.0)
    }
}
struct Tuple2(bool, i32);
#[automatically_derived]
impl ::core::fmt::Debug for Tuple2 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_tuple_field2_finish(f, "Tuple2", &self.0, &&self.1)
    }
}
```

`debug_tuple_fieldN_finish(f, è­˜åˆ¥å­, ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰, ...)` ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

`debug_tuple_fieldN_finish` ã¯ `#[doc(hidden)]` ãŒè¨­å®šã•ã‚ŒãŸé–¢æ•°ã¿ãŸã„ã§ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãªã„ã¨ã„ã†ã“ã¨ã¯ãŠãã‚‰ãå†…éƒ¨çš„ãªã‚‚ã®ã§ç›´æ¥ä½¿ã†ã¹ãã‚‚ã®ã§ã¯ãªã„ã®ã§ã—ã‚‡ã†ã€‚

<https://doc.rust-lang.org/src/core/fmt/mod.rs.html#2394-2403>

```rust
/// Shrinks `derive(Debug)` code, for faster compilation and smaller
/// binaries. `debug_tuple_fields_finish` is more general, but this is faster
/// for 1 field.
#[doc(hidden)]
#[unstable(feature = "fmt_helpers_for_derive", issue = "none")]
pub fn debug_tuple_field1_finish<'b>(&'b mut self, name: &str, value1: &dyn Debug) -> Result {
    let mut builder = builders::debug_tuple_new(self, name);
    builder.field(value1);
    builder.finish()
}
```

`builders::debug_tuple_new` ã¯ `Formatter::debug_tuple` ã®å®Ÿè£…ã¨åŒã˜ã‚‚ã®ã§ã™ã€‚ç‰¹åˆ¥ãªå‹•ããŒã‚ã‚‹ã‚ã‘ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

<https://doc.rust-lang.org/src/core/fmt/mod.rs.html#2390>

```rust
pub fn debug_tuple<'b>(&'b mut self, name: &str) -> DebugTuple<'b, 'a> {
    builders::debug_tuple_new(self, name)
}
```

å…¨ä½“ã¨ã—ã¦ã¯ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã¨ãŠã‚Šã€é«˜é€ŸåŒ–ãªã©ã®è¦³ç‚¹ã‹ã‚‰ `Formatter` ã®çµ„ã¿ç«‹ã¦ã‚’ç°¡ç´ åŒ–ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

### struct

```rust
#[derive(Debug)]
struct Struct1 {
    s: String,
}

#[derive(Debug)]
struct Struct2 {
    nested: Struct1,
}
```

```rust
struct Struct1 {
    s: String,
}
#[automatically_derived]
impl ::core::fmt::Debug for Struct1 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(f, "Struct1", "s", &&self.s)
    }
}
struct Struct2 {
    nested: Struct1,
}
#[automatically_derived]
impl ::core::fmt::Debug for Struct2 {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        ::core::fmt::Formatter::debug_struct_field1_finish(
            f,
            "Struct2",
            "nested",
            &&self.nested,
        )
    }
}
```

å†…éƒ¨çš„ã«ã¯ tuple struct ã¨å¤§å·®ãªãã€ `debug_struct_fieldN_finish` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ (å¼•æ•°ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒå¢—ãˆã¦ã„ã‚‹) ãã‚‰ã„ã§ã™ã€‚

<https://doc.rust-lang.org/src/core/fmt/mod.rs.html#2235>

```rust
/// Shrinks `derive(Debug)` code, for faster compilation and smaller
/// binaries. `debug_struct_fields_finish` is more general, but this is
/// faster for 1 field.
#[doc(hidden)]
#[unstable(feature = "fmt_helpers_for_derive", issue = "none")]
pub fn debug_struct_field1_finish<'b>(
    &'b mut self,
    name: &str,
    name1: &str,
    value1: &dyn Debug,
) -> Result {
    let mut builder = builders::debug_struct_new(self, name);
    builder.field(name1, value1);
    builder.finish()
}
```

`name` ãŒå¢—ãˆã‚‹ãã‚‰ã„ã§ã»ã¨ã‚“ã©åŒã˜ã‚‚ã®ã§ã™ã€‚

`builders::debug_struct_new` ã¯ `Formatter::debug_struct` ã®å®Ÿè£…ã¨åŒã˜ã‚‚ã®ã§ã™ã­ã€‚ã“ã®ã‚ãŸã‚Šã‚‚ tuple struct ã¨ã»ã¼åŒã˜ã§ã™ã€‚

<https://doc.rust-lang.org/src/core/fmt/mod.rs.html#2231>

```rust
pub fn debug_struct<'b>(&'b mut self, name: &str) -> DebugStruct<'b, 'a> {
    builders::debug_struct_new(self, name)
}
```

### enum

æœ€å¾Œã¯ `enum` ã§ã™ã€‚

```rust
#[derive(Debug)]
enum Enum {
    Unit,
    Tuple(bool),
    Struct { n: i32 },
}
```

```rust
enum Enum {
    Unit,
    Tuple(bool),
    Struct { n: i32 },
}
#[automatically_derived]
impl ::core::fmt::Debug for Enum {
    #[inline]
    fn fmt(&self, f: &mut ::core::fmt::Formatter) -> ::core::fmt::Result {
        match self {
            Enum::Unit => ::core::fmt::Formatter::write_str(f, "Unit"),
            Enum::Tuple(__self_0) => {
                ::core::fmt::Formatter::debug_tuple_field1_finish(f, "Tuple", &__self_0)
            }
            Enum::Struct { n: __self_0 } => {
                ::core::fmt::Formatter::debug_struct_field1_finish(
                    f,
                    "Struct",
                    "n",
                    &__self_0,
                )
            }
        }
    }
}
```

`match` ã§åˆ†å²ã—ã€å‹åã®ä»£ã‚ã‚Šã« variant ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚‚ã®ã®ã€ã‚ã¨ã¯ `struct` ã¨åŒã˜ã§ã™ã­ã€‚

## ãŠã‚ã‚Šã«

æœ¬å½“ã¯ã€Œ derive ã®å®Ÿè£…ã€ã«ç¶šã‘ã¦ã€Œæ‰‹å‹•ã§ã®å®Ÿè£…ã€ã‚’æ›¸ãã¤ã‚‚ã‚Šã ã£ãŸã®ã§ã™ãŒã€é•·ããªã£ã¦ã—ã¾ã†ã®ã§æ¬¡å›ã«ã—ã¾ã™ã€‚

æ¬¡å›ã¯ `std::fmt::Formatter` ã‚„ãã‚Œã‚’ä½¿ã£ãŸæ‰‹å‹•ã§ã® `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## å‚è€ƒ

- Debug in std::fmt - Rust <https://doc.rust-lang.org/std/fmt/trait.Debug.html>

[zenn:2832eb691f8fbe]: https://zenn.dev/doctormate/articles/2832eb691f8fbe
[zenn:4d591d072253ca]: https://zenn.dev/doctormate/articles/4d591d072253ca
