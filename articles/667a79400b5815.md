---
emoji: "ğŸ”¥"
publication_name: "doctormate"
published: false
published_at: 2026-03-09 12:00
title: "axum crate ã® Middleware (2) axum::middleware::from_fn"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ axum crate ã® middleware ã®é©ç”¨é †åºã‚’è¦‹ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/363f753577c1f5)ã€‚

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¾ŒåŠã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.6 ã§ã™ã€‚

## axum ã® middleware ã‚’æ›¸ãã«ã¯

ã¾ãšã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯ Writing middleware ä»¥é™ã§ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/index.html>

ã„ãã¤ã‹ã®æ–¹æ³•ãŒä½¿ã†ã¹ãå ´é¢ã¨ã¨ã‚‚ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãšã¯ã–ã£ã¨è¦‹ã¾ã™ã€‚

- [`axum::middleware::from_fn`](https://docs.rs/axum/0.8.6/axum/middleware/fn.from_fn.html)
    - async fn ã¨ `FromRequest(Parts)` ã¨ `IntoResponse` ã«åŠ ãˆã¦ `Next` ã‚’ä½¿ã†é–¢æ•°ã‹ã‚‰å®šç¾©ã™ã‚‹ã‚‚ã®
    - Future ã«æ…£ã‚Œã¦ãŠã‚‰ãšã€ async/await ã§æ›¸ããŸã„
    - crate ã¨ã—ã¦å…¬é–‹ã›ãšã€ axum ã®ã¿ã«äº’æ›æ€§ãŒã‚ã‚‹ã“ã¨ã‚’è¨±å®¹ã§ãã‚‹
    - `State` ã‚’ä½¿ã†ãªã‚‰ [`axum::middleware::from_fn_with_state`](https://docs.rs/axum/0.8.6/axum/middleware/fn.from_fn_with_state.html)
- [`axum::middleware::from_extractor`](https://docs.rs/axum/0.8.6/axum/middleware/fn.from_extractor.html)
    - Extractor ã‹ã‚‰å®šç¾©ã™ã‚‹ã‚‚ã®
    - Extractor ã¨ Middleware ã®ä¸¡æ–¹ã§ä½¿ã„ãŸã„
    - crate ã¨ã—ã¦å…¬é–‹ã›ãšã€ axum ã®ã¿ã«äº’æ›æ€§ãŒã‚ã‚‹ã“ã¨ã‚’è¨±å®¹ã§ãã‚‹
    - Middleware ã¨ã—ã¦ã ã‘ä½¿ã†ãªã‚‰ `axum::middleware::from_fn` ã®ã»ã†ãŒè‰¯ã„
- tower's combinators
    - `tower::ServiceBuilder` ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹ã‚‚ã®
    - ä¾‹
        - [`tower::ServiceBuilder::map_request`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.map_request)
        - [`tower::ServiceBuilder::map_response`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.map_response)
        - [`tower::ServiceBuilder::then`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.then)
        - [`tower::ServiceBuilder::and_then`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.and_then)
    - ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ ãªã©ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãªã‚‚ã®
    - crate ã¨ã—ã¦å…¬é–‹ã—ãªã„ã‚‚ã®
- `tower::Service` and `Pin<Box<dyn Future>>`
    - `tower::Service` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šæœ€å¤§ã®åˆ¶å¾¡ã‚’å¾—ã‚‰ã‚Œã‚‹
    - è¨­å®šå¯èƒ½ã«ã—ãŸã„
    - crate ã¨ã—ã¦å…¬é–‹ã—ãŸã„
    - Future ã«æ…£ã‚Œã¦ã„ãªã„
- `tower::Service` and custom futures
    - Middleware ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æŠ‘ãˆãŸã„
    - `tower::Service` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šæœ€å¤§ã®åˆ¶å¾¡ã‚’å¾—ã‚‰ã‚Œã‚‹
    - è¨­å®šå¯èƒ½ã«ã—ãŸã„
    - crate ã¨ã—ã¦å…¬é–‹ã—ãŸã„
    - Future ã«æ…£ã‚Œã¦ã„ã‚‹ or æ…£ã‚ŒãŸã„
    - <https://github.com/tower-rs/tower/blob/master/guides/building-a-middleware-from-scratch.md>

## axum::middleware::from_fn

æ¬¡ã¯ã€ãã‚Œãã‚Œã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

`axum::middleware::from_fn` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ã€ã“ã®é–¢æ•°ãŒã©ã®ã‚ˆã†ãªé–¢æ•°ã‹ã‚‰ Middleware ã‚’ã¤ãã‚Œã‚‹ã‹ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/fn.from_fn.html>

1. `async fn` ã§ã‚ã‚‹ã“ã¨
2. 0 å€‹ä»¥ä¸Šã® `FromRequestParts` Extractor ã‚’å–ã‚‹ã“ã¨
3. å¾Œã‚ã‹ã‚‰ 2 ç•ªç›®ã®å¼•æ•°ã¨ã—ã¦ 1 å€‹ã® `FromRequest` Extractor ã‚’å–ã‚‹ã“ã¨
4. æœ€å¾Œã®å¼•æ•°ã¨ã—ã¦ `Next` ã‚’å–ã‚‹ã“ã¨
5. `IntoResponse` ã®å®Ÿè£…ã‚’è¿”ã™ã“ã¨

Handler ã¨ã‚ã‚Šã¨ä¼¼ã¦ã„ã¾ã™ã­ã€‚é•ã„ã¯ `Next` ãŒã‚ã‚‹ã“ã¨ã‚„ã€ `FromRequest` å®Ÿè£…ã‚’å¿…é ˆã¨ã™ã‚‹ç‚¹ã§ã—ã‚‡ã†ã‹ã€‚ã‚ã¨ `State` ã®ã¨ãã¯ `from_fn_with_state` ã‚’ä½¿ãˆã¨ã„ã†ã“ã¨ãªã®ã§ã€ãŠãã‚‰ã `State` ã‚‚æŒ‡å®šã§ããªã„ã§ã—ã‚‡ã†ã€‚

```rust
pub fn from_fn<F, T>(f: F) -> FromFnLayer<F, (), T> {
    from_fn_with_state((), f)
}
```

å®Ÿè£…ã¯ `from_fn_with_state` ã‚’ `State` ãŒ `()` ã§ã‚ã‚‹ã‚‚ã®ã¨ã—ã¦ä¸¸æŠ•ã’ã§ã™ã­ã€‚

[`axum::middleware::from_fn_with_state`](https://docs.rs/axum/0.8.6/axum/middleware/fn.from_fn_with_state.html)

```rust
pub fn from_fn_with_state<F, S, T>(state: S, f: F) -> FromFnLayer<F, S, T> {
    FromFnLayer {
        f,
        state,
        _extractor: PhantomData,
    }
}
```

`from_fn_with_state` ã¯ `FromFnLayer` ã‚’è¿”ã—ã¦ãŠã‚Šã€åå‰ã‹ã‚‰ã™ã‚‹ã¨ Layer ã§ã—ã‚‡ã†ã€‚

ãã“ã§ `impl Layer for FromFnLayer` ã®å®Ÿè£…ã‚’ç¢ºèªã—ã¾ã™ã€‚

```rust

impl<S, I, F, T> Layer<I> for FromFnLayer<F, S, T>
where
    F: Clone,
    S: Clone,
{
    type Service = FromFn<F, S, I, T>;

    fn layer(&self, inner: I) -> Self::Service {
        FromFn {
            f: self.f.clone(),
            state: self.state.clone(),
            inner,
            _extractor: PhantomData,
        }
    }
}
```

`impl Layer for FromFnLayer` ã¯ `FromFn` ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚ `Layer::Service` ãªã®ã§ `FromFn` ã¯ `Service` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ãã“ã§ `impl Service for FromFn` ã®å®Ÿè£…ã‚’ç¢ºèªã—ã¾ã™ã€‚

```rust
macro_rules! impl_service {
    (
        [$($ty:ident),*], $last:ident
    ) => {
        #[allow(non_snake_case, unused_mut)]
        impl<F, Fut, Out, S, I, $($ty,)* $last> Service<Request> for FromFn<F, S, I, ($($ty,)* $last,)>
        where
            F: FnMut($($ty,)* $last, Next) -> Fut + Clone + Send + 'static,
            $( $ty: FromRequestParts<S> + Send, )*
            $last: FromRequest<S> + Send,
            Fut: Future<Output = Out> + Send + 'static,
            Out: IntoResponse + 'static,
            I: Service<Request, Error = Infallible>
                + Clone
                + Send
                + Sync
                + 'static,
            I::Response: IntoResponse,
            I::Future: Send + 'static,
            S: Clone + Send + Sync + 'static,
        {
            type Response = Response;
            type Error = Infallible;
            type Future = ResponseFuture;

            fn poll_ready(&mut self, cx: &mut Context<'_>) -> Poll<Result<(), Self::Error>> {
                self.inner.poll_ready(cx)
            }

            fn call(&mut self, req: Request) -> Self::Future {
                let not_ready_inner = self.inner.clone();
                let ready_inner = std::mem::replace(&mut self.inner, not_ready_inner);

                let mut f = self.f.clone();
                let state = self.state.clone();
                let (mut parts, body) = req.into_parts();

                let future = Box::pin(async move {
                    $(
                        let $ty = match $ty::from_request_parts(&mut parts, &state).await {
                            Ok(value) => value,
                            Err(rejection) => return rejection.into_response(),
                        };
                    )*

                    let req = Request::from_parts(parts, body);

                    let $last = match $last::from_request(req, &state).await {
                        Ok(value) => value,
                        Err(rejection) => return rejection.into_response(),
                    };

                    let inner = BoxCloneSyncService::new(MapIntoResponse::new(ready_inner));
                    let next = Next { inner };

                    f($($ty,)* $last, next).await.into_response()
                });

                ResponseFuture {
                    inner: future
                }
            }
        }
    };
}

all_the_tuples!(impl_service);
```

ã“ã‚Œã¯ã“ã®ã‚·ãƒªãƒ¼ã‚ºã§ä½•åº¦ã‚‚è¦‹ãŸ all_the_tuples ã§ã®å®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚

â€¦â€¦ã¨ã¯è¨€ãˆã€ `Next` ã®éƒ¨åˆ†ä»¥å¤–ã¯èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã« `FromRequestParts` ã‚„ `FromRequest` ã‚„ `IntoResponse` ãªã©ã‚’å‡¦ç†ã™ã‚‹ç´ ç›´ãªå®Ÿè£…ã¨ã„ã†å°è±¡ã§ã™ã€‚

`tower::util::BoxCloneSyncService` ã¯è¿½ã‚ãªã„ã§ã™ãŒã€åå‰ã©ãŠã‚Šã®ã‚‚ã®ã§ã—ã‚‡ã†ã€‚

`axum::util::MapIntoResponse` ã‚‚ã“ã“ã§ã¯è¿½ã‚ãªã„ã§ã™ãŒã€ `IntoResponse` ã™ã‚‹ `Future` ã‚’è¿”ã™ `Service` ã§ã—ãŸã€‚

<https://github.com/tokio-rs/axum/blob/axum-v0.8.6/axum/src/util.rs#L49>

`Next` ã¯ã€æ¬¡ã® Middleware ã‚’ inner ã¨ã—ã¦æŒã¡ `run` ã§å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‚ã®ã§ã™ã€‚ã“ã‚Œã‚‚è¦‹ãŸã¨ãŠã‚Šã§ã™ã€‚

ã“ã“ã§ã¯è¨˜äº‹ã®é‡çš„ã«çœç•¥ã—ã¦ã„ã¾ã™ãŒã€ã“ã®ã‚ãŸã‚Šã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ã‚‹ã¨ `tower::Service` æ…£ã‚Œ (?) ãŒæ—ã‚‹ã®ã§ã€è¿½ã£ã¦ãŠãã®ã¯è‰¯ã„ã“ã¨ã®ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¾ŒåŠã«å…¥ã‚Šã¾ã—ãŸã€‚å…¨éƒ¨ã¯è¦‹ã‚Œãš `axum::middleware::from_fn` ã‚’èª­ã‚€ã¨ã“ã‚ã¾ã§ã§ã™ã€‚

å®Ÿéš›ã«æ›¸ã„ãŸã‚Šã—ãŸã‹ã£ãŸã®ã§ã™ãŒ (å®Ÿã¯å‰å›ã®ã‚³ãƒ¼ãƒ‰ã§æ—¢ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™) ã€ä»Šå›ã¯è¦‹é€ã‚ã†ã¨æ€ã„ã¾ã™ã€‚

æ¬¡å›ã¯ä»–ã® Middleware ã‚’æ›¸ãæ–¹æ³•ã‚‚è¦‹ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
