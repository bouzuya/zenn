---
emoji: "ğŸ§ª"
publication_name: "doctormate"
published: true
published_at: 2025-12-22 12:00
title: "axum crate ã®ãƒ†ã‚¹ãƒˆ"
topics: ["rust"]
type: "tech"
---

# axum crate ã®ãƒ†ã‚¹ãƒˆ

[å‰å›ã¯ axum crate ã® Router::fallback ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸ](https://zenn.dev/doctormate/articles/b666c9b0e8fe64)ã€‚

ä»Šå›ã¯ axum crate ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## axum crate ã® examples

ã¾ãšã¯ axum ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã® examples ã« testing ãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ã¦ãã ã•ã„ã€‚

<https://github.com/tokio-rs/axum/tree/axum-v0.8.4/examples/testing>

`Cargo.toml` ã¨ `src/main.rs` ã® 2 ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

`src/main.rs` ã‹ã‚‰ãƒ†ã‚¹ãƒˆã®ã²ã¨ã¤ `hello_world` ã®éƒ¨åˆ†ã‚’å¼•ç”¨ã—ã¾ã™ã€‚

```rust
use super::*;
use axum::{
    body::Body,
    extract::connect_info::MockConnectInfo,
    http::{self, Request, StatusCode},
};
use http_body_util::BodyExt; // for `collect`
use serde_json::{json, Value};
use tokio::net::TcpListener;
use tower::{Service, ServiceExt}; // for `call`, `oneshot`, and `ready`

#[tokio::test]
async fn hello_world() {
    let app = app();

    // `Router` implements `tower::Service<Request<Body>>` so we can
    // call it like any tower service, no need to run an HTTP server.
    let response = app
        .oneshot(Request::builder().uri("/").body(Body::empty()).unwrap())
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);

    let body = response.into_body().collect().await.unwrap().to_bytes();
    assert_eq!(&body[..], b"Hello, World!");
}
```

ã‚³ãƒ¼ãƒ‰ã¨ã‚³ãƒ¡ãƒ³ãƒˆã§ååˆ†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ”¹ã‚ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚

`app` ã¯ `Router` ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã¨ãŠã‚Š axum ã® `Router` ã¯ `tower::Service` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ `tower::Service` ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã¨å¤‰ã‚ã‚‰ãšã€ HTTP ã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

`tower::Service` ãŒä½•ã§ã‚ã‚‹ã‹ã¯ middleware ã‚’å–ã‚Šä¸Šã’ã‚‹ã¨ãã«æ›¸ãã¨æ€ã†ã®ã§ã™ãŒã€é›‘ã«ã¯ [`tower-service` crate ã® README](https://github.com/tower-rs/tower/tree/tower-service-0.3.3/tower-service) ã®ä¸€æ–‡ `async fn(Request) -> Result<Response, Error>` ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚ `Request` ã‚’å¼•æ•°ã«å–ã‚Š `Result<Response, Error>` ã‚’è¿”ã™éåŒæœŸé–¢æ•°ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

è¦ã™ã‚‹ã« `Request` ã‚’æ¸¡ã—ã¦ã€è¿”ã•ã‚Œã‚‹ `Result<Response, Error>` ã‚’ãƒ†ã‚¹ãƒˆã™ã‚Œã°ã„ã„ã ã‘ã§ã™ã€‚

`tower` crate ã¯ `util` feature ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§ `ServiceExt` trait ã‚’ä½¿ç”¨ã§ã `oneshot` ãƒ¡ã‚½ãƒƒãƒ‰ã§å˜ç™ºã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã¾ã™ã€‚

ã“ã‚Œã‚’ä½¿ã†ã¨ `hello_world` ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–ã‚Šå‡ºã™ç®‡æ‰€ãŒã™ã“ã—ã‚„ã‚„ã“ã—ã„ã§ã™ã€‚å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãªã—ã® `collect` ã« `unwrap` ã« `to_bytes` ã§ä½•ãŒãªã«ã‚„ã‚‰ã§ã™ã­ã€‚

```rust
let body = response.into_body().collect().await.unwrap().to_bytes();
assert_eq!(&body[..], b"Hello, World!");
```

[`axum::response::Response::into_body`](https://docs.rs/axum/0.8.4/axum/response/type.Response.html#method.into_body) ã¯ `Response<T>` ã® `T` ã‚’è¿”ã—ã¾ã™ã€‚æ—¢å®šå€¤ã¯ [`axum::body::Body`](https://docs.rs/axum/0.8.4/axum/body/struct.Body.html) ã§ã™ã€‚

[`axum::body::Body::collect`](https://docs.rs/axum/0.8.4/axum/body/struct.Body.html#method.collect) ã¯ [`http_body_util::combinators::Collect`](https://docs.rs/http-body-util/0.1.3/http_body_util/combinators/struct.Collect.html) ã‚’è¿”ã—ã¾ã™ã€‚ `Collect` ã¯ `Future` ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ `Result<Collected<<T as Body>::Data>, <T as Body>::Error>` ã‚’è¿”ã—ã¾ã™ã€‚

[`http_body_util::Collected::to_bytes`](https://docs.rs/http-body-util/0.1.3/http_body_util/struct.Collected.html#method.to_bytes) ã¯ [`bytes::Bytes`](https://docs.rs/bytes/1.0.0/bytes/struct.Bytes.html) ã‚’è¿”ã—ã¾ã™ã€‚

[`impl AsRef<[u8]> for bytes::Bytes`](https://docs.rs/bytes/1.0.0/bytes/struct.Bytes.html#impl-AsRef%3C%5Bu8%5D%3E) ãŒã‚ã‚‹ã®ã§ã€ `b"Hello, World!"` ã¨æ¯”è¼ƒã§ãã‚‹ã‚ã‘ã§ã™ã­ã€‚

ã‚‚ã†é€”ä¸­ã‹ã‚‰ä»–ã®ã‚¯ãƒ¬ãƒ¼ãƒˆã®è©±ã§ã™ã­ã€‚

## å€‹äººçš„ãªä½¿ã„æ–¹

ã¼ãã¯[å‰å›](https://zenn.dev/doctormate/articles/b666c9b0e8fe64)ã®[ä¾‹](https://github.com/bouzuya/rust-examples/blob/cbf90f555d773ef11d1ed1437b338674ef13ebf4/axum5/src/main.rs)ã§ã‚‚ä½¿ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€ç°¡å˜ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’æ›¸ã„ã¦ä½¿ã†ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ã“ã†ã„ã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚

```rust
async fn send_request(
    router: axum::Router<()>,
    request: axum::http::Request<axum::body::Body>,
) -> anyhow::Result<axum::response::Response<axum::body::Body>> {
    let response = tower::ServiceExt::oneshot(router, request).await?;
    Ok(response)
}

trait ResponseExt {
    async fn into_body_string(self) -> anyhow::Result<String>;
}

impl ResponseExt for axum::response::Response<axum::body::Body> {
    async fn into_body_string(self) -> anyhow::Result<String> {
        let bytes = axum::body::to_bytes(self.into_body(), usize::MAX).await?;
        Ok(String::from_utf8(bytes.to_vec())?)
    }
}
```

ã“ã†ã„ã†æ„Ÿã˜ã§ä½¿ã„ã¾ã™ã€‚

```rust
#[tokio::test]
async fn test_path_not_found() -> anyhow::Result<()> {
    let router = router();
    let request = axum::http::Request::builder()
        .method(axum::http::Method::GET)
        .uri("/unknown")
        .body(axum::body::Body::empty())?;
    let response = send_request(router, request).await?;
    assert_eq!(response.status(), axum::http::StatusCode::OK);
    assert_eq!(response.into_body_string().await?, "fallback");
    Ok(())
}
```

`send_request` ã¯ `tower::ServiceExt::oneshot` ã‚’ wrap ã—ãŸã‚‚ã®ã§ã€å‹ã‚’å›ºå®šã—ã¦æ‰±ã„ã‚„ã™ãã—ã¦ã„ã¾ã™ã€‚

`into_body_string` ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’æ–‡å­—åˆ—ã«ã—ã¦è¿”ã™ã‚‚ã®ã§ã™ã€‚

æ¥­å‹™ã§ã¯ã•ã‚‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§çµæœã¨æ¯”è¼ƒã—ãŸã‚Šâ€¦â€¦ã¿ãŸã„ãªã“ã¨ã‚’ã—ã¾ã™ãŒã€æœ€ä½ã“ã‚Œãã‚‰ã„ã‚’ç”¨æ„ã™ã‚‹ã ã‘ã§ã‚‚å€‹äººçš„ã«ã¯æ‰±ã„ã‚„ã™ã„ã§ã™ã€‚ unwrap ã‚„ã‚‰ collect ã‚„ã‚‰èª­ã¿ã¥ã‚‰ãã¦ä»•æ–¹ãªã„ã®ã§ã€‚

axum ã¯ 0.7 ã‹ã‚‰ `Body` ãŒ `hyper::Body` ã‹ã‚‰ axum å›ºæœ‰ã® struct ã«ãªã£ã¦æ‰±ã„ã‚„ã™ããªã£ãŸã‚ˆã†ã«æ€ã„ã¾ã™ (ç ´å£Šçš„å¤‰æ›´ã¯ã‚¢ãƒ¬ã§ã—ãŸã‘ã©â€¦â€¦) ã€‚

[`axum::body::to_bytes`](https://docs.rs/axum/0.8.4/axum/body/fn.to_bytes.html) ã¯ `axum::body::Body` ã‹ã‚‰ `bytes::Bytes` ã«å¤‰æ›ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

`response.into_body().collect().await.unwrap().to_bytes()` ã‚ˆã‚Šã¯ `axum::body::to_bytes(response.into_body(), usize::MAX).await.unwrap()` ã®ã»ã†ãŒèª­ã¿ã‚„ã™ããªã„ã§ã™ã‹ï¼Ÿã€€ã•ã™ãŒã«å¥½ã¿ã®å•é¡Œã§ã™ã‹ã­â€¦â€¦ã€‚

## ãŠã‚ã‚Š

ä»Šå›ã¯ axum crate ã® examples ã‹ã‚‰ testing ã‚’ãªãŒã‚ã¤ã¤ã€å€‹äººçš„ã«ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

æ¬¡å›ã¯ãŠãã‚‰ã axum crate ã® Router ã® merge ã‚„ nest ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚
