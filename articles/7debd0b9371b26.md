---
emoji: "ï¸ğŸ”¨"
publication_name: "doctormate"
published: true
published_at: 2025-11-17 12:00
title: "Debug ãƒˆãƒ¬ã‚¤ãƒˆã®æ‰‹å‹•å®Ÿè£…"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ Debug ãƒˆãƒ¬ã‚¤ãƒˆã® derive å±æ€§ã§ã®å®Ÿè£…ã‚’ç¢ºèªã—ã¾ã—ãŸ][zenn:5c561314513dc9]ã€‚

ä»Šå›ã¯å‰å›ã®ç¶šããªã®ã§ã™ãŒã€ [`Debug` ãƒˆãƒ¬ã‚¤ãƒˆ](https://doc.rust-lang.org/std/fmt/trait.Debug.html)ã‚’æ‰‹å‹•ã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## ã„ã¤ Debug ãƒˆãƒ¬ã‚¤ãƒˆã¯æ‰‹å‹•å®Ÿè£…ã™ã‚‹ï¼Ÿ

[å‰å›][zenn:5c561314513dc9]æ›¸ã„ãŸã¨ãŠã‚Šã€ã»ã¨ã‚“ã©ã®å ´åˆã« `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã¯ derive å±æ€§ã§å®Ÿè£…ã§ãã¾ã™ã€‚ã§ã¯ã€ã„ã¤ã€æ‰‹å‹•ã§å®Ÿè£…ã™ã‚‹ã®ã§ã—ã‚‡ã†ï¼Ÿ

ã„ãã¤ã‹ã®ä¾‹ã‚’æŒ™ã’ã¾ã™ã€‚

- `Debug` ã§ã¯ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã¨ã
- å‡ºåŠ›ã—ãŸããªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã¨ã
- thiserror ã® transparent ã®ã‚ˆã†ãªæŒ™å‹•ã«ã—ãŸã„ã¨ã

### Debug ã§ã¯ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã¨ã

`Debug` ã§ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€å ´åˆã¯ `derive` å±æ€§ã§ã®å®Ÿè£…ã¯ã§ãã¾ã›ã‚“ã€‚

```rust
struct NonDebug;

#[derive(Debug)]
struct MyDebug {
    field: NonDebug,
}
```

```text
error[E0277]: `NonDebug` doesn't implement `Debug`
 --> tests/ui/compile_fail_non_debug_field.rs:5:5
  |
3 | #[derive(Debug)]
  |          ----- in this derive macro expansion
4 | struct MyDebug {
5 |     field: NonDebug,
  |     ^^^^^^^^^^^^^^^ `NonDebug` cannot be formatted using `{:?}`
  |
  = help: the trait `Debug` is not implemented for `NonDebug`
  = note: add `#[derive(Debug)]` to `NonDebug` or manually `impl Debug for NonDebug`
help: consider annotating `NonDebug` with `#[derive(Debug)]`
  |
1 + #[derive(Debug)]
2 | struct NonDebug;
  |
```

ã“ã†ã„ã†ã¨ãã¯æ‰‹å‹•ã§ `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ã€ `Debug` ã§ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ€ãƒŸãƒ¼ã®æ–‡å­—åˆ—ã‚’ä½¿ã†ãªã©ã—ã¦å›é¿ã§ãã¾ã™ã€‚

```rust
struct NonDebug;

struct MyDebug {
    field: NonDebug,
}

impl std::fmt::Debug for MyDebug {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("MyDebug")
            .field("field", &"NonDebug")
            .finish()
    }
}

fn main() {
    assert_eq!(
        format!("{:?}", MyDebug { field: NonDebug }),
        "MyDebug { field: \"NonDebug\" }"
    );
}
```

### å‡ºåŠ›ã—ãŸããªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã¨ã

å‡ºåŠ›ã—ãŸããªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã‚’æ‰‹å‹•å®Ÿè£…ã™ã‚‹çŠ¶æ³ã¨ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã¯ã€ãã®ã¾ã¾ãƒ­ã‚°ãªã©ã«ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã—ã¦ã—ã¾ã†ã¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€ `derive` å±æ€§ã§å®Ÿè£…ã™ã‚‹ã¨ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã«å«ã¾ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```rust
#[derive(Debug)]
struct Input1 {
    email: String,
    password: String,
}
assert_eq!(
    format!(
        "{:?}",
        Input1 {
            email: "happy@example.com".to_owned(),
            password: "password".to_owned()
        }
    ),
    "Input1 { email: \"happy@example.com\", password: \"password\" }"
);
```

æ‰‹å‹•å®Ÿè£…ã§ã‚ã‚Œã°ã€å‡ºåŠ›ã—ãŸããªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤–ã—ãŸã‚Šã€ãƒã‚¹ã‚¯ã™ã‚‹ãªã©ã®å¯¾å¿œãŒã§ãã¾ã™ã€‚

```rust
struct Input2 {
    email: String,
    password: String,
}

impl std::fmt::Debug for Input2 {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_struct("Input2")
            .field("email", &self.email)
            .field("password", &"********")
            .finish()
    }
}

assert_eq!(
    format!(
        "{:?}",
        Input2 {
            email: "happy@example.com".to_owned(),
            password: "password".to_owned()
        }
    ),
    "Input2 { email: \"happy@example.com\", password: \"********\" }"
);
```

### thiserror ã® transparent ã®ã‚ˆã†ãªæŒ™å‹•ã«ã—ãŸã„ã¨ã

æœ€å¾Œã¯ç‹¬è‡ªã® trait ã®å®Ÿè£…ãªã©ã®ãŸã‚ã«æ—¢å­˜ã®å‹ã‚’ wrap ã—ãŸå ´åˆ (newtype ãƒ‘ã‚¿ãƒ¼ãƒ³) ã§ã™ã€‚

ç´ æœ´ã« `derive` å±æ€§ã§å®Ÿè£…ã™ã‚‹ã¨ã€ `Id(Id(...))` ã®ã‚ˆã†ã«å…¥ã‚Œå­ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹å½¢ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚å®Ÿå®³ã¯ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ `Id(...)` ã®ã‚ˆã†ã«å†…å´ã®å‹ã‚’é€éçš„ã«å‡ºåŠ›ã§ãã‚‹ã»ã†ãŒå¬‰ã—ã„ã“ã¨ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

```rust
mod other {
    #[derive(Debug)]
    pub struct Id(pub String);
}

mod example1 {
    #[derive(Debug)]
    pub struct Id(pub super::other::Id);
}

mod example2 {
    pub struct Id(pub super::other::Id);
    impl std::fmt::Debug for Id {
        fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
            std::fmt::Debug::fmt(&self.0, f)
        }
    }
}

fn main() {
    assert_eq!(
        format!("{:?}", other::Id("abc123".to_owned())),
        "Id(\"abc123\")"
    );

    assert_eq!(
        format!("{:?}", example1::Id(other::Id("abc123".to_owned()))),
        "Id(Id(\"abc123\"))"
    );

    assert_eq!(
        format!("{:?}", example2::Id(other::Id("abc123".to_owned()))),
        "Id(\"abc123\")"
    );
}
```

## ã‚‚ã£ã¨ã„ã‚ã„ã‚ãªå½¢å¼ã§å‡ºåŠ›ã—ãŸã„

æ—¢ã«èª¬æ˜ãªãä½¿ã£ã¦ã„ã¾ã™ãŒã€ `fmt` ã®å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹ `std::fmt::Formatter` ã‚’ä½¿ã†ã¨ã€ã„ã‚ã„ã‚ãªå½¢å¼ã§å‡ºåŠ›ã§ãã¾ã™ã€‚

ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç”¨æ„ã«çµ„ã¿ç«‹ã¦ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ã€â†“ã®ã‚ˆã†ãªã‚‚ã®ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

- `debug_list`
- `debug_map`
- `debug_set`
- `debug_struct`
- `debug_tuple`

ã“ã‚Œã‚‰ã§ãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ç”Ÿæˆã—ã€ `field` ã‚„ `entry` ãªã©ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ã—ã¦ã€ `finish` ã‚„ `finish_non_exhaustive` ã§å‡ºåŠ›ã‚’çµ‚ãˆã¾ã™ã€‚

ãã†ã„ã£ãŸæ§‹é€ ã«å¯„ã›ã‚‹å¿…è¦ãŒãªã„ãªã‚‰ `f.write_str()` ã§ä»»æ„ã®æ–‡å­—åˆ—å½¢å¼ã‚’å‡ºåŠ›ã§ãã¾ã™ã€‚

ãƒªã‚¹ãƒˆã‚„ãƒãƒƒãƒ—ã§ãªã„ã‚‚ã®ã‚‚ã€ãã‚Œã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã¨åŒæ§˜ã®å½¢å¼ã§å‡ºåŠ›ã§ãã¾ã™ã€‚

```rust
struct MyList(i32, i32);

impl std::fmt::Debug for MyList {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_list().entry(&self.0).entry(&self.1).finish()
    }
}

struct MyMap(i32, i32);

impl std::fmt::Debug for MyMap {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_map().entry(&self.0, &self.1).finish()
    }
}

struct MySet(i32, i32);

impl std::fmt::Debug for MySet {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        f.debug_set().entry(&self.0).entry(&self.1).finish()
    }
}

assert_eq!(format!("{:?}", MyList(1, 2)), "[1, 2]");
assert_eq!(format!("{:?}", MyMap(1, 2)), "{1: 2}");
assert_eq!(format!("{:?}", MySet(1, 2)), "{1, 2}");
```

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ `Debug` ãƒˆãƒ¬ã‚¤ãƒˆã®æ‰‹å‹•å®Ÿè£…ã™ã‚‹çŠ¶æ³ã‚„ `std::fmt::Formatter` ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸã€‚

æ¬¡å›ã¯ `axum` crate ã«ã¤ã„ã¦æ›¸ã“ã†ã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒ

- Debug in std::fmt - Rust <https://doc.rust-lang.org/std/fmt/trait.Debug.html>
- Formatter in std::fmt - Rust <https://doc.rust-lang.org/std/fmt/struct.Formatter.html>

[zenn:5c561314513dc9]: https://zenn.dev/doctormate/articles/5c561314513dc9
