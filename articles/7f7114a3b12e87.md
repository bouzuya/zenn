---
emoji: "📖"
publication_name: "doctormate"
published: true
published_at: 2026-01-12 12:00
title: "axum crate の Handler の実装を見てみよう"
topics: ["rust"]
type: "tech"
---

[前回は axum crate の Handler について書きました](https://zenn.dev/doctormate/articles/5657ef250f7bd2)。

今回は [axum crate](https://crates.io/crates/axum) の Handler のソースコードを見ていきます。

今回も axum crate のバージョンは 0.8.4 です。

## 関数のための Handler の実装

まずは、もっともありふれた形である関数のために提供されている `Handler` trait のブランケット実装を見ます。

### 引数がない関数のための実装

引数がない関数のための実装を見ます。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/handler/mod.rs#L193-L204>

```rust
impl<F, Fut, Res, S> Handler<((),), S> for F
where
    F: FnOnce() -> Fut + Clone + Send + Sync + 'static,
    Fut: Future<Output = Res> + Send,
    Res: IntoResponse,
{
    type Future = Pin<Box<dyn Future<Output = Response> + Send>>;

    fn call(self, _req: Request, _state: S) -> Self::Future {
        Box::pin(async move { self().await.into_response() })
    }
}
```

関数を呼び出し `into_response` した結果を `async {}` し `Box::pin` して返しています。トレイト境界などは複数引数のときの説明と重複するので後述します。

### 複数引数の関数のための実装 impl_handler macro とその使用箇所

複数引数の関数のための実装である `impl_handler` macro の定義を見ます。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/handler/mod.rs#L206-L244>

```rust
macro_rules! impl_handler {
    (
        [$($ty:ident),*], $last:ident
    ) => {
        #[allow(non_snake_case, unused_mut)]
        impl<F, Fut, S, Res, M, $($ty,)* $last> Handler<(M, $($ty,)* $last,), S> for F
        where
            F: FnOnce($($ty,)* $last,) -> Fut + Clone + Send + Sync + 'static,
            Fut: Future<Output = Res> + Send,
            S: Send + Sync + 'static,
            Res: IntoResponse,
            $( $ty: FromRequestParts<S> + Send, )*
            $last: FromRequest<S, M> + Send,
        {
            type Future = Pin<Box<dyn Future<Output = Response> + Send>>;


            fn call(self, req: Request, state: S) -> Self::Future {
                let (mut parts, body) = req.into_parts();
                Box::pin(async move {
                    $(
                        let $ty = match $ty::from_request_parts(&mut parts, &state).await {
                            Ok(value) => value,
                            Err(rejection) => return rejection.into_response(),
                        };
                    )*


                    let req = Request::from_parts(parts, body);


                    let $last = match $last::from_request(req, &state).await {
                        Ok(value) => value,
                        Err(rejection) => return rejection.into_response(),
                    };


                    self($($ty,)* $last,).await.into_response()
                })
            }
        }
    };
}
```

詳細は後に回して、 `impl_handler` の使用箇所 (呼び出し) を見ます。 `all_the_tuples` macro に渡す形で使われています。

`all_the_tuples!(impl_handler);`

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/handler/mod.rs#L246>

### all_the_tuples macro

`all_the_tuples` macro の定義を見ます。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/macros.rs#L49-L68>

```rust
macro_rules! all_the_tuples {
    ($name:ident) => {
        $name!([], T1);
        $name!([T1], T2);
        $name!([T1, T2], T3);
        $name!([T1, T2, T3], T4);
        $name!([T1, T2, T3, T4], T5);
        $name!([T1, T2, T3, T4, T5], T6);
        $name!([T1, T2, T3, T4, T5, T6], T7);
        $name!([T1, T2, T3, T4, T5, T6, T7], T8);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8], T9);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9], T10);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10], T11);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11], T12);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12], T13);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12, T13], T14);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12, T13, T14], T15);
        $name!([T1, T2, T3, T4, T5, T6, T7, T8, T9, T10, T11, T12, T13, T14, T15], T16);
    };
}
```

T1 〜 T16 の可変の引数に対して渡された macro を呼び出しているようです。

### impl_handler macro のトレイト境界

`impl_handler` macro の定義の詳細を見ていきます。

まず `Handler` の型パラメーターのトレイト境界を見ます。

```rust
impl<F, Fut, S, Res, M, $($ty,)* $last> Handler<(M, $($ty,)* $last,), S> for F
where
    F: FnOnce($($ty,)* $last,) -> Fut + Clone + Send + Sync + 'static,
    Fut: Future<Output = Res> + Send,
    S: Send + Sync + 'static,
    Res: IntoResponse,
    $( $ty: FromRequestParts<S> + Send, )*
    $last: FromRequest<S, M> + Send,
```

`impl<...> Handler<...> for F` の `F` は `FnOnce($($ty,)* $last,) -> Fut + Clone + Send + Sync + 'static` です。

`F` は `FnOnce` で `Clone + Send + Sync + 'static` を満たす必要があります。

`F` の `FnOnce` の引数は T1 から T16 の可変です。このための `all_the_tuples!` ですね。最後のひとつは `$last` で特別扱いされています。

最後のひとつのみ `FromRequest<S, M> + Send` でそれ以外は `FromRequestParts<S> + Send` です。

`S` は `Send + Sync + 'static` 。 `M` は任意の型ですね。

`FromRequest` と `FromRequestParts` は Extractor となるための trait で、 Extractor について書く際に改めて調べます。ひとまず `S` は `State` の型です。

<https://docs.rs/axum/0.8.4/axum/extract/trait.FromRequest.html>
<https://docs.rs/axum/0.8.4/axum/extract/trait.FromRequestParts.html>

`F` の `FnOnce` の戻り値は `Fut` です。 `Fut` は `Future<Output = Res> + Send` です。

`Res` は `IntoResponse` です。

ルール通りのものへの実装が提供されていそうです。

### impl_handler macro のトレイト境界

`impl_handler` macro の定義の詳細を見ていきます。

次に `Handler` の実装を見ます。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/handler/mod.rs#L220-L241>

```rust
type Future = Pin<Box<dyn Future<Output = Response> + Send>>;

fn call(self, req: Request, state: S) -> Self::Future {
    let (mut parts, body) = req.into_parts();
    Box::pin(async move {
        $(
            let $ty = match $ty::from_request_parts(&mut parts, &state).await {
                Ok(value) => value,
                Err(rejection) => return rejection.into_response(),
            };
        )*

        let req = Request::from_parts(parts, body);

        let $last = match $last::from_request(req, &state).await {
            Ok(value) => value,
            Err(rejection) => return rejection.into_response(),
        };

        self($($ty,)* $last,).await.into_response()
    })
}
```

最後のひとつ以外は `from_request_parts` を呼び、最後のひとつは `from_request` を呼びます。

最後は `self` を呼び出して `into_response` 。素直な実装ですね。

全体を `async {}` で括って `Box::pin` して返しています。

## IntoResponse のための Handler の実装

[前回](https://zenn.dev/doctormate/articles/5657ef250f7bd2)驚いた `IntoResponse` な値のための `Handler` のブランケット実装を見ていきます。

<https://github.com/tokio-rs/axum/blob/axum-v0.8.4/axum/src/handler/mod.rs#L248-L263>

```rust
mod private {
    // Marker type for `impl<T: IntoResponse> Handler for T`
    #[allow(missing_debug_implementations)]
    pub enum IntoResponseHandler {}
}

impl<T, S> Handler<private::IntoResponseHandler, S> for T
where
    T: IntoResponse + Clone + Send + Sync + 'static,
{
    type Future = std::future::Ready<Response>;

    fn call(self, _req: Request, _state: S) -> Self::Future {
        std::future::ready(self.into_response())
    }
}
```

すっきりした実装です。 `into_response` したものを `std::future::ready` で返すだけですね。

## おわりに

axum crate の `Handler` の実装を見てみました。

次回は Extractor を追いかけてみようと思います。
