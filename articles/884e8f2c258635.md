---
emoji: "ğŸ—ï¸"
publication_name: "doctormate"
published: true
published_at: 2025-11-03 12:00
title: "trybuild crate ã§ã® derive macro ã®ãƒ†ã‚¹ãƒˆ"
topics: ["rust"]
type: "tech"
---

# trybuild crate ã§ã® derive macro ã®ãƒ†ã‚¹ãƒˆ

[å‰å›ã¯ derive macro ã® helper attributes ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸ][zenn:2832eb691f8fbe]ã€‚ä»Šå›ã¯å‰å›ã®ä¾‹ã‚’ `trybuild` crate ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## trybuild crate ã¨ã¯

[`trybuild` crate][crates:trybuild] ã¯ `rustc` ã‚’å‘¼ã³å‡ºã—ã¦ãã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ã® assert ã‚’æ›¸ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ crate ã§ã™ã€‚

GitHub ãƒªãƒã‚¸ãƒˆãƒªã¯ [dtolnay/trybuild] ã§ã™ã€‚ãã¡ã‚‰ã® README ã‚’èª­ã‚“ã ã»ã†ãŒæ­£ç¢ºã§ã™ã€‚

ç”¨é€”ã¯æ‰‹ç¶šãçš„ãƒã‚¯ãƒ­ (procedural macro) ã‚„ãã®ä¸€ç¨®ã§ã‚ã‚‹ derive macro ã«é™å®šã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã§ã™ãŒã€ãƒã‚¯ãƒ­ã®åˆ©ç”¨æ–¹æ³•ã®èª¤ã‚Šãªã©ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ãã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚

## ä½¿ç”¨ã®æµã‚Œ

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«æ¬¡ã®ã‚ˆã†ãª `trybuild` ã‚’ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```rust
#[test]
fn ui() {
    let t = trybuild::TestCases::new();
    t.compile_fail("tests/ui/fail1.rs");
}
```

ãƒ•ã‚¡ã‚¤ãƒ«åã«ã¯ `*.rs` ã®ã‚ˆã†ãª glob ã®æŒ‡å®šã‚‚ã§ãã¾ã™ã€‚

`compile_fail` ã§æŒ‡å®šã•ã‚ŒãŸå„ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ‹¡å¼µå­ã‚’ `.stderr` ã«ã—ãŸæ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã•ã‚Œã¾ã™ã€‚

`.stderr` ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã‹ãšã« `cargo test` ã™ã‚‹ã¨ `wip` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’è¨˜éŒ²ã—ãŸãƒ•ã‚¡ã‚¤ãƒ« (`wip/*.stderr`) ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãã‚ŒãŒæœŸå¾…å€¤ã§è‰¯ã„ãªã‚‰ `tests/ui` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã‚„ã‚Œã°è‰¯ã„ã§ã™ã€‚

ã‚ã‚‹ç¨®ã® snapshot testing ã§ã™ã­ã€‚

## å‰å›ã®ä¾‹ã«é©ç”¨

å‰å›ã¯ derive macro ã« `rename` ã¨ã„ã† helper attributes ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

```rust
#[derive(derive1::VariantsFn)]
enum E1 {
    #[rename = "X"]
    A,
    B(i32),
    C { b: bool },
}

fn main() {
    assert_eq!(E1::variants(), &["X", "B", "C"]);
}
```

ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã®å…¨ä½“ã¯ <https://github.com/bouzuya/rust-examples/tree/cdbbab3cdaee194a6c77bb8613bb5e5024d7f6ba/derive_macro1/crates/derive1> ã«ã‚ã‚Šã¾ã™ã€‚

`tests/lib.rs` ã« `trybuild` crate ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ›¸ãã¾ã™ã€‚

```rust
#[test]
fn main() {
    let test_cases = trybuild::TestCases::new();
    test_cases.compile_fail("tests/ui/compile-fail-0.rs");
    test_cases.pass("tests/ui/pass-no-variants.rs");
    test_cases.pass("tests/ui/pass-with-helper-attr.rs");
    test_cases.pass("tests/ui/pass.rs");
}
```

ä»Šå›ã¯ `compile_fail` ã®ã»ã‹ã« `pass` ã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

`tests/ui/*.rs` ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚ãƒ‘ã‚¹ã¯ `ui/` ã§ãªãã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€å‚è€ƒã«ã—ãŸ `thiserror` ã‚„ `trybuild` æœ¬ä½“ãŒ UI ãƒ†ã‚¹ãƒˆã®ä¸€ç¨®ã¨ã—ã¦æ‰±ã£ã¦ã„ã‚‹ã‹ã‚‰ã‹ `ui/` ã®ä¸‹ã«é…ç½®ã—ã¦ã„ãŸã®ã§ã€ãã‚Œã‚’è¸è¥²ã—ã¦ã„ã¾ã™ã€‚

`tests/ui/compile-fail-0.rs` ã®ä¾‹ã§ã™ã€‚

```rust
fn main() {
    #[derive(derive1::VariantsFn)]
    enum E {
        #[rename]
        A,
        B,
        C,
    }
}
```

`rename` ã«ã¯ `= "X"` ã®ã‚ˆã†ãªæŒ‡å®šãŒå¿…è¦ã§ã‚ã‚Šã€ã“ã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

`tests/ui/compile-fail-0.stderr` ã«æ¬¡ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚

```text
error: expected `#[rename = "name"]` attribute
 --> tests/ui/compile-fail-0.rs:4:9
  |
4 |         #[rename]
  |         ^
```

å…ˆã»ã©ã‚‚æ›¸ã„ãŸã¨ãŠã‚Š `cargo test` ã™ã‚Œã°ã€ `wip` ã®ä¸‹ã«è‡ªå‹•ã§â†‘ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’ç§»å‹•ã™ã‚‹ã ã‘ã§ OK ã§ã™ã€‚

`tests/ui/pass-with-helper-attr.rs` ã®ä¾‹ã§ã™ã€‚

```rust
fn main() {
    #[derive(derive1::VariantsFn)]
    enum E {
        #[rename = "X"]
        A,
        B,
        C,
    }
    assert_eq!(E::variants(), &["X", "B", "C"]);
}
```

ã“ã‚Œã¯ãƒ‘ã‚¹ã™ã‚‹ä¾‹ã§ã™ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ãŒã€ãƒ‘ã‚¹ã™ã‚‹ä¾‹ã‚‚æ›¸ã‘ã¾ã™ã€‚

ä»–ã«ã‚‚å‰ã€…å›ã®å†…å®¹ãªã©ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ã‚“ãŸã‚“ãªä¾‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚è©³ç´°ã¯çœç•¥ã—ã¾ã™ã€‚

```text
$ cargo test
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.05s
     Running unittests src/lib.rs (/home/bouzuya/ghq/github.com/bouzuya/rust-examples/derive_macro1/target/debug/deps/derive1-6dcbf849355ffcd5)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/lib.rs (/home/bouzuya/ghq/github.com/bouzuya/rust-examples/derive_macro1/target/debug/deps/lib-2b054ca7f2c12bea)

running 1 test
   Compiling derive1-tests v0.0.0 (/home/bouzuya/ghq/github.com/bouzuya/rust-examples/derive_macro1/target/tests/trybuild/derive1)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.34s


test tests/ui/compile-fail-0.rs [should fail to compile] ... ok
test tests/ui/pass-no-variants.rs [should pass] ... ok
test tests/ui/pass-with-helper-attr.rs [should pass] ... ok
test tests/ui/pass.rs [should pass] ... ok


test main ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.83s

   Doc-tests derive1

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
```

ã„ã„ã§ã™ã­ã€‚

`*.stderr` ã‚’æ¶ˆã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªå‡ºåŠ›ãŒã•ã‚Œã¾ã™ã€‚

```text
test tests/ui/compile-fail-0.rs [should fail to compile] ... wip

NOTE: writing the following output to `wip/compile-fail-0.stderr`.
Move this file to `tests/ui/compile-fail-0.stderr` to accept it as correct.
â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ
error: expected `#[rename = "name"]` attribute
 --> tests/ui/compile-fail-0.rs:4:9
  |
4 |         #[rename]
  |         ^
â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ
```

æŒ‡ç¤ºé€šã‚Šã«é…ç½®ã™ã‚‹ã¨å…ˆã®è¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ `trybuild` crate ã§ derive macro ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã—ãŸã€‚ã™ã”ã„ãŠæ‰‹è»½ã«ãƒã‚¯ãƒ­ã®ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã®ã§åŠ©ã‹ã‚Šã¾ã™ã­ã€‚ `*.stderr` ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨ã“ã‚ã®ä½“é¨“ã‚‚è‰¯ã„æ„Ÿã˜ã§ã™ã€‚

æ¬¡å›ã¯åŸºæœ¬ã«ã‹ãˆã£ã¦ `Debug` trait ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## å‚è€ƒ

- <https://crates.io/crates/trybuild>
- <https://github.com/dtolnay/trybuild>

[crates:trybuild]: https://crates.io/crates/trybuild
[dtolnay/trybuild]: https://github.com/dtolnay/trybuild
[zenn:2832eb691f8fbe]: https://zenn.dev/doctormate/articles/2832eb691f8fbe
