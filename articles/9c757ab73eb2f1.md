---
emoji: "ğŸ™"
publication_name: "doctormate"
published: true
published_at: 2026-03-23 12:00
title: "axum crate ã® Middleware (4) tower's combinators"
topics: ["rust"]
type: "tech"
---

[å‰å›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Writing middleware ã‹ã‚‰ axum::middleware::from_extractor ã«ã¤ã„ã¦è¦‹ã¾ã—ãŸ](https://zenn.dev/doctormate/articles/2582963afb4646)ã€‚

ä»Šå›ã¯ axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ tower's combinators ä»¥é™ã‚’èª­ã‚“ã§ã„ãã¾ã™ã€‚

ä»Šå›ã‚‚ axum crate ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 0.8.6 ã§ã™ã€‚

## tower's combinators

ã¾ãšã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¾ã™ã€‚å‰å›ã¯ `axum::middleware::from_extractor` ã®ã¨ã“ã‚ã¾ã§ã ã£ãŸã®ã§ã€ãã®ç¶šãã® tower's combinators ã‹ã‚‰ã§ã™ã€‚

<https://docs.rs/axum/0.8.6/axum/middleware/index.html>

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ tower ã® combinator ã®ä¾‹ã¨ã—ã¦æ¬¡ã®ã‚‚ã®ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

- [`ServiceBuilder::map_request`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.map_request)
- [`ServiceBuilder::map_response`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.map_response)
- [`ServiceBuilder::then`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.then)
- [`ServiceBuilder::and_then`](https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html#method.and_then)

ã“ã‚Œã‚‰ `tower::ServiceBuilder` ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ `ServiceBuilder` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹ã¨ãŠã‚Šã€ãƒ“ãƒ«ãƒ€ãƒ¼ã£ã½ã„å½¢ã§ `tower::Service` ã‚’åˆæˆã—ã¦æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

<https://docs.rs/tower/0.5.2/tower/builder/struct.ServiceBuilder.html>

axum ã® middleware ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ ã®ã‚ˆã†ãªã€ã‚¢ãƒ‰ãƒ›ãƒƒã‚¯ãªå°ã•ã„æ“ä½œã‚’åŠ ãˆã‚‹ã¨ãã€ã‹ã¤ crate ã¨ã—ã¦å…¬é–‹ã—ãªã„å ´åˆã«ä½¿ã†ã¨è‰¯ã„ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚

ã¼ãã®è§£é‡ˆã¨ã—ã¦ã¯ã€ã“ã‚Œã‚‰ã¯ axum ã® Middleware ã‚’ã¤ãã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ `tower::Service` ã‚’ã¤ãã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

axum ã¯ Middleware ã¨ã—ã¦ `tower::Service` ã‚’ä½¿ã†ã¨èª¬æ˜ã—ã¦ããŸã¨ãŠã‚Šã€ä¸¡è€…ã¯ã»ã¨ã‚“ã©åŒã˜ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã« axum ã® Middleware ã¨ã—ã¦é©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€æœ€çµ‚çš„ã« `tower::Service` ã®é–¢é€£å‹ã«ã¤ã„ã¦ã€ `Error` ã‚’ `Into<std::convert::Infallible>` ã«ã—ãŸã‚Šã€ `Request` ã‚’ `axum::http::Request<axum::body::Body>` ã«ã—ãŸã‚Šã€ `Response` ã‚’ `axum::response::IntoResponse` ã«ã™ã‚‹ãªã©ã®å¯¾å¿œãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä¹±æš´ã«è¨€ã†ãªã‚‰ `tower::Service` ã®ã»ã†ãŒã‚ˆã‚Šæ±ç”¨ã§ã™ã€‚

ã•ã¦ã€å„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚‚ã†ã™ã“ã—è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

## `tower::ServiceBuilder::map_request` ã®å®Ÿè£…

```rust
pub fn map_request<F, R1, R2>(
    self,
    f: F,
) -> ServiceBuilder<Stack<crate::util::MapRequestLayer<F>, L>>
where
    F: FnMut(R1) -> R2 + Clone,
{
    self.layer(crate::util::MapRequestLayer::new(f))
}
```

`MapRequestLayer` ã‚’ `ServiceBuilder::layer` ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã‚ˆã†ã§ã™ã€‚

<https://docs.rs/tower/0.5.2/tower/util/struct.MapRequestLayer.html>

```rust
impl<F> MapRequestLayer<F> {
    /// Creates a new [`MapRequestLayer`].
    pub const fn new(f: F) -> Self {
        MapRequestLayer { f }
    }
}

impl<S, F> Layer<S> for MapRequestLayer<F>
where
    F: Clone,
{
    type Service = MapRequest<S, F>;

    fn layer(&self, inner: S) -> Self::Service {
        MapRequest {
            f: self.f.clone(),
            inner,
        }
    }
}
```

`MapRequestLayer` ã¯ `MapRequest` ã‚’ Service ã¨ã—ã¦è¿”ã™ Layer ã§ã™ã€‚

```rust
impl<S, F, R1, R2> Service<R1> for MapRequest<S, F>
where
    S: Service<R2>,
    F: FnMut(R1) -> R2,
{
    type Response = S::Response;
    type Error = S::Error;
    type Future = S::Future;

    #[inline]
    fn poll_ready(&mut self, cx: &mut Context<'_>) -> Poll<Result<(), S::Error>> {
        self.inner.poll_ready(cx)
    }

    #[inline]
    fn call(&mut self, request: R1) -> S::Future {
        self.inner.call((self.f)(request))
    }
}
```

`MapRequest` ã¯ã„ã‹ã«ã‚‚ map ã§ã™ã­ã€‚

`map_response` ã‚„ `then` ã‚„ `and_then` ã‚‚ã»ã¨ã‚“ã©åŒã˜ã¤ãã‚Šã«ãªã£ã¦ã„ãŸã®ã§ã€ä»¥é™ã¯å‰²æ„›ã—ã¾ã™ã€‚

## `map_request` ã‚’è©¦ã—ã¦ã¿ã‚‹

<https://github.com/bouzuya/rust-examples/blob/ae2f0dad56a203cab59084732f83e8218483acdd/axum10/src/main.rs>

```rust
#[tokio::test]
async fn test_map_request() -> anyhow::Result<()> {
    async fn handler(header_map: axum::http::HeaderMap) -> String {
        format!("X-NAME: {:?}", header_map.get("X-NAME"))
    }

    let app = axum::Router::<()>::new()
        .route("/", axum::routing::get(handler))
        .layer(tower::ServiceBuilder::new().map_request(
            |mut request: axum::http::Request<axum::body::Body>| {
                request
                    .headers_mut()
                    .insert("X-NAME", axum::http::HeaderValue::from_static("bouzuya"));
                request
            },
        ));
    let response = send_request(
        app,
        axum::http::Request::builder()
            .method("GET")
            .uri("/")
            .body(axum::body::Body::empty())?,
    )
    .await?;
    assert_eq!(response.status(), axum::http::StatusCode::OK);
    assert_eq!(
        response.into_body_string().await?,
        "X-NAME: Some(\"bouzuya\")"
    );
    Ok(())
}
```

`map_request` ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ Middleware ã‚’è©¦ã—ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚ã“ã“ã§ã¯ `Request` ã‚’åŠ å·¥ã—ã¦è¿”ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚

## `map_response` ã‚’è©¦ã—ã¦ã¿ã‚‹

<https://github.com/bouzuya/rust-examples/blob/ae2f0dad56a203cab59084732f83e8218483acdd/axum10/src/main.rs>

```rust
#[tokio::test]
async fn test_map_response() -> anyhow::Result<()> {
    let app = axum::Router::<()>::new()
        .route("/", axum::routing::get("Original Body"))
        .layer(tower::ServiceBuilder::new().map_response(
            |mut response: axum::http::Response<axum::body::Body>| {
                *response.body_mut() = axum::body::Body::from("New Body");
                response
            },
        ));
    let response = send_request(
        app,
        axum::http::Request::builder()
            .method("GET")
            .uri("/")
            .body(axum::body::Body::empty())?,
    )
    .await?;
    assert_eq!(response.status(), axum::http::StatusCode::OK);
    assert_eq!(response.into_body_string().await?, "New Body");
    Ok(())
}
```

`map_response` ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’æ›¸ãæ›ãˆã‚‹ Middleware ã‚’è©¦ã—ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚ã“ã“ã§ã‚‚ `Response` ã‚’åŠ å·¥ã—ã¦è¿”ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚

## `then` ã‚’è©¦ã—ã¦ã¿ã‚‹

<https://github.com/bouzuya/rust-examples/blob/ae2f0dad56a203cab59084732f83e8218483acdd/axum10/src/main.rs>

```rust
#[tokio::test]
async fn test_then() -> anyhow::Result<()> {
    let app = axum::Router::<()>::new()
        .route("/", axum::routing::get("Original Body"))
        .layer(tower::ServiceBuilder::new().then(
            |result: Result<
                axum::response::Response<axum::body::Body>,
                std::convert::Infallible,
            >| async {
                match result {
                    Ok(mut response) => {
                        *response.body_mut() = axum::body::Body::from("New Body");
                        Ok(response)
                    }
                    Err(e) => Err(e),
                }
            },
        ));
    let response = send_request(
        app,
        axum::http::Request::builder()
            .method("GET")
            .uri("/")
            .body(axum::body::Body::empty())?,
    )
    .await?;
    assert_eq!(response.status(), axum::http::StatusCode::OK);
    assert_eq!(response.into_body_string().await?, "New Body");
    Ok(())
}
```

`then` ã§ã™ã€‚ã“ã‚Œã¯ `Result` ã‚’å—ã‘å–ã‚Œã‚‹ã®ã§ã™ãŒã€ä»Šå›ã®ä¾‹ã¯ã‚¤ãƒã‚¤ãƒã§ã™ã­ã€‚æœ¬æ¥ã¯æˆåŠŸã®ã‚‚ã®ã‚’æ¡ä»¶æ¬¡ç¬¬ã§å¤±æ•—æ‰±ã„ã«ã—ãŸã‚Šã€ãã®é€†ãŒã§ãã‚‹ã¨æ€ã†ã®ã§ã™ãŒã€ä»Šå›ã¯å˜ä¸€ã® Middleware ã¨ã—ã¦æ›¸ã„ã¦ã„ã‚‹ã®ã§ã€ãã†ã„ã†æ´»ã‹ã—æ–¹ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãŠãã‚‰ãè¤‡æ•°ã® Middleware ã‚’çµ„ã¿åˆã‚ã›ã‚‹éš›ã«ä½¿ãˆã°ã€æˆ»ã‚Šå€¤ã®èª¿æ•´ã«ä½¿ãˆã‚‹ã¨æ€ã„ã¾ã™ã€‚

## `and_then` ã‚’è©¦ã—ã¦ã¿ã‚‹

<https://github.com/bouzuya/rust-examples/blob/ae2f0dad56a203cab59084732f83e8218483acdd/axum10/src/main.rs>

```rust
#[tokio::test]
async fn test_and_then() -> anyhow::Result<()> {
    let app = axum::Router::<()>::new()
        .route("/", axum::routing::get("Original Body"))
        .layer(tower::ServiceBuilder::new().and_then(
            |mut response: axum::response::Response<axum::body::Body>| async move {
                *response.body_mut() = axum::body::Body::from("New Body");
                Result::<
                            axum::response::Response<axum::body::Body>,
                            std::convert::Infallible,
                        >::Ok(response)
            },
        ));
    let response = send_request(
        app,
        axum::http::Request::builder()
            .method("GET")
            .uri("/")
            .body(axum::body::Body::empty())?,
    )
    .await?;
    assert_eq!(response.status(), axum::http::StatusCode::OK);
    assert_eq!(response.into_body_string().await?, "New Body");
    Ok(())
}
```

`and_then` ã§ã™ã€‚ã“ã‚Œã¯ `then` ã«ä¼¼ãŸå‹•ãã‚’æˆåŠŸæ™‚ã®å€¤ã‚’ã‚‚ã¨ã«â€¦â€¦ã¨ã„ã†ã¨ã“ã‚ã§ã™ã­ã€‚æ„Ÿæƒ³ã«ã¤ã„ã¦ã¯ `then` å´ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚


## ãŠã‚ã‚Šã«

ä»Šå›ã¯ axum ã® middleware ã® tower's combinators ã‚’è¦‹ã¾ã—ãŸã€‚

axum ã¨ã„ã†ã‚ˆã‚Šã¯ tower ã‚’è¦‹ã¦ã„ã‚‹ã«è¿‘ã„å½¢ã§ã—ãŸã€‚

æ¬¡å›ã‚‚å¼•ãç¶šãã€ä»–ã® Middleware ã‚’æ›¸ãæ–¹æ³•ã‚‚è¦‹ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

